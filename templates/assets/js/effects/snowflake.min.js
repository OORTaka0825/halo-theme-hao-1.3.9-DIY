/*! snowflake.min.js — RAF + 单例/自检 */
(function(){
  var G = window.__SNOWFALL__ || (window.__SNOWFALL__={
    canvas:null,ctx:null,flakes:[],raf:0,running:false,last:0,bound:false
  });

  function norm(m){ if(!m||m==="none")return ""; if(m==="light")return "day"; if(m==="dark")return "night"; return m; }
  function need(){
    var cfg=(window.DreamConfig&&window.DreamConfig.effects_snowflake_mode)||"",mode=norm(cfg);
    if(!mode) return false;
    var dark= document.documentElement.classList.contains("night") ||
              document.documentElement.getAttribute("data-theme")==="dark";
    if(mode==="all")return true; if(mode==="day")return !dark; if(mode==="night")return dark; return false;
  }

  function ensureCanvas(){
    if(G.canvas && document.body.contains(G.canvas)) return;
    var c=document.getElementById("snowfall");
    if(!c){
      c=document.createElement("canvas");
      c.id="snowfall";
      c.className="canvas_effects "+(norm((window.DreamConfig&&window.DreamConfig.effects_snowflake_mode)||"")||"");
      // 固定定位、透明、不挡点击；z-index 留低，交给你 head 里那段守卫 CSS 最终兜底
      c.style.cssText="position:fixed;left:0;top:0;width:100vw;height:100vh;pointer-events:none;z-index:1;background:transparent";
      c.setAttribute("aria-hidden","true");
      document.body.appendChild(c);
    }
    G.canvas=c; G.ctx=c.getContext("2d",{alpha:true}); resize();
  }
  function destroy(){
    if(G.raf){ cancelAnimationFrame(G.raf); G.raf=0; }
    G.running=false; G.last=0; G.flakes.length=0; G.ctx=null;
    if(G.canvas){ try{ G.canvas.remove(); }catch(e){} G.canvas=null; }
  }
  function resize(){
    if(!G.canvas) return;
    var dpr=window.devicePixelRatio||1;
    var w=Math.max(document.documentElement.clientWidth, window.innerWidth||0);
    var h=Math.max(document.documentElement.clientHeight,window.innerHeight||0);
    G.canvas.width = Math.floor(w*dpr);
    G.canvas.height= Math.floor(h*dpr);
    G.canvas.style.width = w+"px";
    G.canvas.style.height= h+"px";
    if(G.ctx) G.ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  function R(a,b){ return a+Math.random()*(b-a); }
  function makeFlake(randY){
    var dpr=window.devicePixelRatio||1, w=(G.canvas?G.canvas.width/dpr:window.innerWidth), h=(G.canvas?G.canvas.height/dpr:window.innerHeight);
    var r=R(1.2,3.6), vx=R(-20,20), vy=R(35,85);
    return {x:Math.random()*w,y:randY?Math.random()*h:-10-Math.random()*40,r:r,vx:vx,vy:vy,sway:R(0.5,1.8),ph:Math.random()*Math.PI*2};
  }
  function initFlakes(){
    var dpr=window.devicePixelRatio||1, w=(G.canvas?G.canvas.width/dpr:window.innerWidth);
    var base=/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)?40:90;
    var density=Math.min(1.6,Math.max(0.7,w/1440));
    var count=Math.round(base*density);
    G.flakes.length=0;
    for(var i=0;i<count;i++) G.flakes.push(makeFlake(true));
  }
  function tick(ts){
    if(!G.running) return;
    if(!G.last) G.last=ts;
    var dt=Math.min(0.033,(ts-G.last)/1000); // 秒；封顶 33ms，防后台恢复跳变
    G.last=ts;
    var ctx=G.ctx; if(!ctx) return;
    var dpr=window.devicePixelRatio||1, w=(G.canvas?G.canvas.width/dpr:window.innerWidth), h=(G.canvas?G.canvas.height/dpr:window.innerHeight);
    ctx.clearRect(0,0,w,h);
    for(var i=0;i<G.flakes.length;i++){
      var f=G.flakes[i];
      f.ph+=f.sway*dt;
      var wind=Math.sin(f.ph)*12;
      f.x+=(f.vx+wind)*dt;
      f.y+=f.vy*dt;
      if(f.y-f.r>h+4||f.x<-20||f.x>w+20) G.flakes[i]=makeFlake(false);
      ctx.globalAlpha=0.9; ctx.fillStyle="#fff"; ctx.beginPath(); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); ctx.fill();
    }
    G.raf=requestAnimationFrame(tick);
  }

  function start(){
    if(G.running){
      if(!G.canvas||!document.body.contains(G.canvas)){ destroy(); }
      else { resize(); return; }
    }
    ensureCanvas(); initFlakes();
    if(!G.bound){
      G.bound=true;
      window.addEventListener("resize", function(){ resize(); initFlakes(); });
      document.addEventListener("visibilitychange", function(){
        if(document.hidden){ if(G.raf){cancelAnimationFrame(G.raf); G.raf=0;} G.last=0; }
        else if(G.running){ G.last=0; G.raf=requestAnimationFrame(tick); }
      });
      // 主题切换与 PJAX 完成时，同步状态
      window.addEventListener("hao:mode-change", ensure, {passive:true});
      window.addEventListener("pjax:complete",   ensure, {passive:true});
    }
    G.running=true; G.last=0; G.raf=requestAnimationFrame(tick);
  }
  function stop(){ if(!G.running&&!G.canvas) return; destroy(); }
  function ensure(){ if(need()) start(); else stop(); }

  // 脚本首次执行：根据当前模式跑一次
  ensure();
  // 暴露调试（可选）
  window.SnowflakeEffect = {start:start,stop:stop,ensure:ensure};
})();
