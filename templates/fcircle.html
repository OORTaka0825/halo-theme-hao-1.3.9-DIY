<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{modules/layouts/layout :: layout(content = ~{::content}, htmlType = 'fcircle',title = ${singlePage.spec.title + ' | ' + site.title}, head = ~{::head} )}">
<th:block th:fragment="head">
  <!-- OG：优先主题设置，再回落页面字段 -->
  <th:block th:replace="~{modules/common/open-graph :: open-graph(
    _title    = ${ !#strings.isEmpty(theme.config.fcircle.bigTitle) ? theme.config.fcircle.bigTitle
                  : (!#strings.isEmpty(theme.config.fcircle.title) ? theme.config.fcircle.title : singlePage.spec.title) },
    _permalink= ${ singlePage.status.permalink },
    _cover    = ${
                    !#strings.isEmpty(theme.config.fcircle.backgroundImg) ? theme.config.fcircle.backgroundImg
                    : (!#strings.isEmpty(theme.config.fcircle.background) ? theme.config.fcircle.background
                    : (!#strings.isEmpty(theme.config.fcircle.bg) ? theme.config.fcircle.bg : singlePage.spec.cover))
                 },
    _excerpt  = ${
                    !#strings.isEmpty(theme.config.fcircle.detail) ? theme.config.fcircle.detail
                    : (!#strings.isEmpty(theme.config.fcircle.description) ? theme.config.fcircle.description
                    : (!#strings.isEmpty(theme.config.fcircle.desc) ? theme.config.fcircle.desc : singlePage.status.excerpt))
                 },
    _type     = 'website'
  )}"></th:block>
</th:block>

<th:block th:fragment="content">
  <div class="page" id="body-wrap">

    <!-- 顶部导航标题 -->
    <header class="not-top-img" id="page-header">
      <nav th:replace="~{modules/nav :: nav(
        title = ${ !#strings.isEmpty(theme.config.fcircle.bigTitle) ? theme.config.fcircle.bigTitle
                  : (!#strings.isEmpty(theme.config.fcircle.title) ? theme.config.fcircle.title : singlePage.spec.title) }
      )}"></nav>
  <!-- 引入 heo-fcircle3.css 但放入独立 CSS Layer，避免全局通用规则覆盖鱼塘样式 -->
  <link rel="stylesheet" th:href="${assets_link + '/libs/fcircle/heo-fcircle3.css'}" layer="heo" type="text/css">

  <!-- 最小化修复：若 heo 在部分浏览器仍影响到鱼塘图片/混合模式，这里精准复原 -->
  <style id="fcircle-min-fix">
    #hexo-circle-of-friends-root, #hexo-circle-of-friends-root *{
      mix-blend-mode: normal;
    }
    #hexo-circle-of-friends-root img{
      filter: none;
      transform: none;
      object-fit: cover;
      background: none;
      max-width: 100%;
      height: auto;
      display: block;
    }
  </style>

    </header>

    <main class="layout hide-aside" id="content-inner">
      <div id="page">

        <!-- 头图组件：背景/小标题/大标题/描述 -->
        <div th:replace="~{macro/author-content :: author-content(
          background = ${
                          !#strings.isEmpty(theme.config.fcircle.backgroundImg) ? theme.config.fcircle.backgroundImg
                          : (!#strings.isEmpty(theme.config.fcircle.background) ? theme.config.fcircle.background
                          : (!#strings.isEmpty(theme.config.fcircle.bg) ? theme.config.fcircle.bg : singlePage.spec.cover))
                        },
          smallTitle = ${ !#strings.isEmpty(theme.config.fcircle.smallTitle) ? theme.config.fcircle.smallTitle
                        : (!#strings.isEmpty(theme.config.fcircle.subTitle) ? theme.config.fcircle.subTitle
                        : (!#strings.isEmpty(theme.config.fcircle.subtitle) ? theme.config.fcircle.subtitle : '友链')) },
          bigTitle   = ${ !#strings.isEmpty(theme.config.fcircle.bigTitle) ? theme.config.fcircle.bigTitle
                        : (!#strings.isEmpty(theme.config.fcircle.title) ? theme.config.fcircle.title : singlePage.spec.title) },
          detail     = ${
                          !#strings.isEmpty(theme.config.fcircle.detail) ? theme.config.fcircle.detail
                          : (!#strings.isEmpty(theme.config.fcircle.description) ? theme.config.fcircle.description
                          : (!#strings.isEmpty(theme.config.fcircle.desc) ? theme.config.fcircle.desc : singlePage.spec.excerpt.raw))
                        },
          buttonUrl  = ${ !#strings.isEmpty(theme.config.fcircle.buttonUrl) ? theme.config.fcircle.buttonUrl : site.url },
          buttonTitle= ${ !#strings.isEmpty(theme.config.fcircle.buttonTitle) ? theme.config.fcircle.buttonTitle : '部署项目' }
        )}"></div>

        <!-- 🎣 钓鱼 -->
        <th:block th:if="${theme.config.fcircle.fcircleRandomFriendsEnable}">
          <div class="title-h2-a">
            <div class="title-h2-a-left">
              <h2 style="padding-top:0;margin:.6rem 0 .6rem">🎣 钓鱼</h2>
              <a class="random-post-start" href="javascript:fetchRandomPost();">
                <i class="haofont hao-icon-arrow-rotate-right"></i>
              </a>
            </div>
            <div th:if="${not #strings.isEmpty(theme.config.link.linksUrl)}" class="title-h2-a-right">
              <a class="random-post-all" th:href="${theme.config.link.linksUrl}">全部友链</a>
            </div>
          </div>
          <div id="random-post"></div>
          <script>
            var fdataUser = {
              apiurl: "[(${theme.config.fcircle.apiurl})]",
              defaultFish: 500,
              hungryFish: 500,
            };
          </script>
          <script th:src="${assets_link + '/libs/moments/random-friends-post.js'}"></script>
        </th:block>

        <!-- 🐟 鱼塘 -->
        <div class="title-h2-a">
          <div class="title-h2-a-left">
            <h2 style="padding-top:0;margin:.6rem 0 .6rem">🐟 鱼塘</h2>
          </div>
          <div class="title-h2-a-right"><span>以下内容自动生成，未经审核</span></div>
        </div>

        <div id="hexo-circle-of-friends-root"></div>
        <script>
          var UserConfig = {
            private_api_url: "[(${theme.config.fcircle.apiurl})]",  // 这里填纯基址，如 https://hao-yutang.vercel.app 或 /api
            page_turning_number: 12,
            error_img: "https://sdn.geekzu.org/avatar/57d8260dfb55501c37dde588e7c3852c",
            sort_rule: "created"
          };
        </script>
        <link rel="stylesheet" th:href="${assets_link + '/libs/moments/heoMainColor.css'}">
        <script th:src="${assets_link + '/libs/moments/app.min.js'}"></script>
        <script th:src="${assets_link + '/libs/moments/bundle.js'}"></script>

        <style>
          .cf-manage-pannel[data-v-34921c7c]{width:80%!important;height:80%!important}
          .cf-article-author:hover{color:var(--heo-card-bg)!important}
          #cf-more:hover{background:var(--heo-lighttext)!important;color:var(--heo-card-bg)!important}
        </style>

      </div>
    </main>

    <footer th:replace="~{modules/footer}"/>
    <script th:if="${theme.config.other.bubbleEnable}" async data-pjax th:src="${assets_link + '/libs/canvas/bubble.js'}"></script>
  </div>
</th:block>
</html>

<!-- Auto-click "∞" to load more, without touching images or styles -->
<script data-pjax id="fcircle-autoclick-infinity-safe">
(function(){
  var rootSel = '#hexo-circle-of-friends-root';
  var cardSel = rootSel + ' .cf-card, ' + rootSel + ' .cf-item';
  var btnSel  = '#cf-more, .cf-more, .moments-more';

  function $btn(){ return document.querySelector(btnSel); }
  function cardsCount(){ return document.querySelectorAll(cardSel).length; }
  function isInfinity(el){
    if (!el) return false;
    return (el.textContent || '').replace(/\s+/g,'').trim() === '∞';
  }

  function waitCardsIncrease(prev){
    return new Promise(function(resolve){
      var ticks = 0;
      var it = setInterval(function(){
        var now = cardsCount();
        if (now > prev){ clearInterval(it); resolve(true); }
        if (++ticks > 40){ clearInterval(it); resolve(false); } // ~2s guard
      }, 50);
    });
  }

  async function drain(){
    var tries = 0, last = cardsCount();
    while (tries < 200){
      var b = $btn();
      if (!isInfinity(b)) break; // Stop when it's no longer "∞" (e.g., "一切皆有尽头")
      try{ b.click(); }
      catch(e){
        try{ b.dispatchEvent(new MouseEvent('click', {bubbles:true, cancelable:true})); }catch(_){}
      }
      tries++;
      var ok = await waitCardsIncrease(last);
      if (!ok) break;
      last = cardsCount();
    }
  }

  function start(){
    var checks = 0;
    var timer = setInterval(function(){
      if (cardsCount() > 0 && $btn()){
        clearInterval(timer);
        drain();
      }
      if (++checks > 80) clearInterval(timer);
    }, 250);
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', start, {once:true});
  } else {
    setTimeout(start, 30);
  }
  // For PJAX navigations (if used)
  document.addEventListener && document.addEventListener('pjax:complete', start);
})();
</script>
