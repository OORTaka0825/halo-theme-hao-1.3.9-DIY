<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{modules/layouts/layout :: layout(content = ~{::content}, htmlType = 'fcircle',title = ${singlePage.spec.title + ' | ' + site.title}, head = ~{::head} )}">
<th:block th:fragment="head">
  <!-- OGï¼šä¼˜å…ˆä¸»é¢˜è®¾ç½®ï¼Œå†å›è½é¡µé¢å­—æ®µ -->
  <th:block th:replace="~{modules/common/open-graph :: open-graph(
    _title    = ${ !#strings.isEmpty(theme.config.fcircle.bigTitle) ? theme.config.fcircle.bigTitle
                  : (!#strings.isEmpty(theme.config.fcircle.title) ? theme.config.fcircle.title : singlePage.spec.title) },
    _permalink= ${ singlePage.status.permalink },
    _cover    = ${
                    !#strings.isEmpty(theme.config.fcircle.backgroundImg) ? theme.config.fcircle.backgroundImg
                    : (!#strings.isEmpty(theme.config.fcircle.background) ? theme.config.fcircle.background
                    : (!#strings.isEmpty(theme.config.fcircle.bg) ? theme.config.fcircle.bg : singlePage.spec.cover))
                 },
    _excerpt  = ${
                    !#strings.isEmpty(theme.config.fcircle.detail) ? theme.config.fcircle.detail
                    : (!#strings.isEmpty(theme.config.fcircle.description) ? theme.config.fcircle.description
                    : (!#strings.isEmpty(theme.config.fcircle.desc) ? theme.config.fcircle.desc : singlePage.status.excerpt))
                 },
    _type     = 'website'
  )}"></th:block>
</th:block>

<th:block th:fragment="content">
  <div class="page" id="body-wrap">

    <!-- é¡¶éƒ¨å¯¼èˆªæ ‡é¢˜ -->
    <header class="not-top-img" id="page-header">
      <nav th:replace="~{modules/nav :: nav(
        title = ${ !#strings.isEmpty(theme.config.fcircle.bigTitle) ? theme.config.fcircle.bigTitle
                  : (!#strings.isEmpty(theme.config.fcircle.title) ? theme.config.fcircle.title : singlePage.spec.title) }
      )}"></nav>
    </header>

    <main class="layout hide-aside" id="content-inner">
      <div id="page">

        <!-- å¤´å›¾ç»„ä»¶ï¼šèƒŒæ™¯/å°æ ‡é¢˜/å¤§æ ‡é¢˜/æè¿° -->
        <div th:replace="~{macro/author-content :: author-content(
          background = ${
                          !#strings.isEmpty(theme.config.fcircle.backgroundImg) ? theme.config.fcircle.backgroundImg
                          : (!#strings.isEmpty(theme.config.fcircle.background) ? theme.config.fcircle.background
                          : (!#strings.isEmpty(theme.config.fcircle.bg) ? theme.config.fcircle.bg : singlePage.spec.cover))
                        },
          smallTitle = ${ !#strings.isEmpty(theme.config.fcircle.smallTitle) ? theme.config.fcircle.smallTitle
                        : (!#strings.isEmpty(theme.config.fcircle.subTitle) ? theme.config.fcircle.subTitle
                        : (!#strings.isEmpty(theme.config.fcircle.subtitle) ? theme.config.fcircle.subtitle : 'å‹é“¾')) },
          bigTitle   = ${ !#strings.isEmpty(theme.config.fcircle.bigTitle) ? theme.config.fcircle.bigTitle
                        : (!#strings.isEmpty(theme.config.fcircle.title) ? theme.config.fcircle.title : singlePage.spec.title) },
          detail     = ${
                          !#strings.isEmpty(theme.config.fcircle.detail) ? theme.config.fcircle.detail
                          : (!#strings.isEmpty(theme.config.fcircle.description) ? theme.config.fcircle.description
                          : (!#strings.isEmpty(theme.config.fcircle.desc) ? theme.config.fcircle.desc : singlePage.spec.excerpt.raw))
                        },
          buttonUrl  = ${ !#strings.isEmpty(theme.config.fcircle.buttonUrl) ? theme.config.fcircle.buttonUrl : site.url },
          buttonTitle= ${ !#strings.isEmpty(theme.config.fcircle.buttonTitle) ? theme.config.fcircle.buttonTitle : 'éƒ¨ç½²é¡¹ç›®' }
        )}"></div>

        <!-- ğŸ£ é’“é±¼ -->
        <th:block th:if="${theme.config.fcircle.fcircleRandomFriendsEnable}">
          <div class="title-h2-a">
            <div class="title-h2-a-left">
              <h2 style="padding-top:0;margin:.6rem 0 .6rem">ğŸ£ é’“é±¼</h2>
              <a class="random-post-start" href="javascript:fetchRandomPost();">
                <i class="haofont hao-icon-arrow-rotate-right"></i>
              </a>
            </div>
            <div th:if="${not #strings.isEmpty(theme.config.link.linksUrl)}" class="title-h2-a-right">
              <a class="random-post-all" th:href="${theme.config.link.linksUrl}">å…¨éƒ¨å‹é“¾</a>
            </div>
          </div>
          <div id="random-post"></div>
          <script>
            var fdataUser = {
              apiurl: "[(${theme.config.fcircle.apiurl})]",
              defaultFish: 500,
              hungryFish: 500,
            };
          </script>
          <script th:src="${assets_link + '/libs/moments/random-friends-post.js'}"></script>
        </th:block>

        <!-- ğŸŸ é±¼å¡˜ -->
        <div class="title-h2-a">
          <div class="title-h2-a-left">
            <h2 style="padding-top:0;margin:.6rem 0 .6rem">ğŸŸ é±¼å¡˜</h2>
          </div>
          <div class="title-h2-a-right"><span>ä»¥ä¸‹å†…å®¹è‡ªåŠ¨ç”Ÿæˆï¼Œæœªç»å®¡æ ¸</span></div>
        </div>

        <div id="hexo-circle-of-friends-root"></div>
        <script>
          var UserConfig = {
            private_api_url: "[(${theme.config.fcircle.apiurl})]",  // è¿™é‡Œå¡«çº¯åŸºå€ï¼Œå¦‚ https://hao-yutang.vercel.app æˆ– /api
            page_turning_number: 24,
            error_img: "https://sdn.geekzu.org/avatar/57d8260dfb55501c37dde588e7c3852c",
            sort_rule: "created"
          };
        </script>
        <link rel="stylesheet" th:href="${assets_link + '/libs/moments/heoMainColor.css'}">
        <script th:src="${assets_link + '/libs/moments/app.min.js'}"></script>
        <script th:src="${assets_link + '/libs/moments/bundle.js'}"></script>
<!-- fcircle é¡¶å›¾â‡„ä¸‹æ‹‰ åˆ‡æ¢ä¿®å¤ v2ï¼ˆä»…æ·»åŠ ï¼Œä¸æ”¹/åˆ ä»»ä½•åŸä»£ç ï¼‰ -->
<script data-pjax id="fcircle-scroll-toggle-v2">
(function(){
  var SCROLLER_KEY = '__fcircleScrollFix';
  function $(sel, ctx){ return (ctx||document).querySelector(sel); }
  function inFcircle(){ return !!$('#hexo-circle-of-friends-root'); }
  function navEl(){ return $('#page-header nav'); }
  function headerEl(){ return $('#page-header'); }

  function getThreshold(){
    // é˜ˆå€¼ï¼šé±¼å¡˜åˆ—è¡¨å®¹å™¨é¡¶åˆ°æ–‡æ¡£é¡¶çš„è·ç¦» - å¯¼èˆªé«˜åº¦ï¼ˆå‘ä¸‹æ»šè¿‡æ­¤å¤„ -> æ·±è‰²ï¼‰
    var root = $('#hexo-circle-of-friends-root');
    var nav = navEl();
    if(!root || !nav) return 60;
    var rootTopDoc = root.getBoundingClientRect().top + window.scrollY;
    var nh = nav.offsetHeight || 60;
    return Math.max(0, rootTopDoc - nh - 10);
  }

  function ensureHandler(){
    if(!inFcircle()) return;
    var nav = navEl();
    var header = headerEl();
    if(!nav || !header) return;

    // å…ˆæ¸…ä¸€æ¬¡ï¼Œé¿å…é‡å¤ç»‘å®š
    if(window[SCROLLER_KEY]){
      window.removeEventListener('scroll', window[SCROLLER_KEY], {passive:true});
      window.removeEventListener('resize', window[SCROLLER_KEY]);
    }

    var threshold = getThreshold();
    var ticking = false;
    function onScroll(){
      if(ticking) return;
      ticking = true;
      requestAnimationFrame(function(){
        ticking = false;
        var y = window.scrollY || document.documentElement.scrollTop || 0;
        if(y >= threshold){
          // ä¸‹æ‹‰ï¼šæ·±è‰²
          header.classList.add('not-top-img');
          header.classList.remove('top-img');
          nav.classList.remove('nav-transparent');
        }else{
          // é¡¶å›¾ï¼šé€æ˜
          header.classList.add('top-img');
          header.classList.remove('not-top-img');
          nav.classList.add('nav-transparent');
        }
      });
    }
    // ç«‹å³åŒæ­¥ä¸€æ¬¡ï¼ˆè¿›å…¥é¡µé¢æ—¶ï¼‰
    onScroll();

    // ç»‘å®šå¹¶è®°å½•
    window.addEventListener('scroll', onScroll, {passive:true});
    window.addEventListener('resize', onScroll);
    window[SCROLLER_KEY] = onScroll;
  }

  // åˆå§‹åŒ– & PJAX å®Œæˆåé‡æŒ‚
  if(document.readyState !== 'loading') { setTimeout(ensureHandler, 0); }
  else { document.addEventListener('DOMContentLoaded', function(){ setTimeout(ensureHandler, 0); }, { once:true }); }
  document.addEventListener('pjax:complete', function(){ setTimeout(ensureHandler, 0); });
})();
</script>

<!-- è‡ªåŠ¨ç‚¹å‡»â€œåŠ è½½æ›´å¤šâ€ï¼šæŒ‰é’®ä¸€è¿›å…¥å¯è§†åŒºå°±è‡ªåŠ¨ç‚¹å‡»ï¼ˆä¿ç•™åŸæŒ‰é’®ä¸åˆ°åº•æç¤ºï¼‰ -->
<script data-pjax id="fcircle-auto-click-more">
(function(){
  const ROOT = document.querySelector('#hexo-circle-of-friends-root');
  if(!ROOT) return;

  const END_TEXT_RE = /å°½å¤´|æ²¡æœ‰æ›´å¤š|å·²åˆ°åº•|END/i;
  let io = null, busy = false;

  function getBtn(){
    // ä¸»é¢˜å¯èƒ½åŠ¨æ€æ›¿æ¢æŒ‰é’®ï¼Œè¿™é‡Œæ¯æ¬¡éƒ½ç°å–
    return document.getElementById('cf-more') || ROOT.querySelector('#cf-more');
  }
  function getState(){
    return document.getElementById('cf-state') || ROOT.querySelector('#cf-state');
  }
  function isFinished(){
    const st = getState();
    return (!getBtn() && st) || (st && END_TEXT_RE.test((st.textContent||'').trim()));
  }

  function clickIfVisible(){
    const btn = getBtn();
    if(!btn || busy) return;
    // ä»…å½“æŒ‰é’®å¤„äºå¯è§çŠ¶æ€ä¸”åœ¨å¯è§†åŒºå†…æ—¶æ‰è§¦å‘
    const rect = btn.getBoundingClientRect();
    const visible = !!(btn.offsetParent !== null && rect.height > 0 && rect.width > 0);
    const inViewport = rect.top < window.innerHeight && rect.bottom > 0;
    if(!visible || !inViewport) return;

    busy = true
    btn.click();
    // ç­‰å¾…æ¸²æŸ“å®Œæˆï¼Œé™ä½è§¦å‘é¢‘ç‡
    setTimeout(()=> busy = false, 800);
  }

  function attachObserver(){
    // å…ˆæ¸…ç†æ—§çš„
    if(io) { try{ io.disconnect(); }catch(e){} io = null; }

    const btn = getBtn();
    if(!btn){ 
      // æ²¡æœ‰æŒ‰é’®åˆ™å¯èƒ½æ˜¯åˆ°åº•äº†ï¼Œå°è¯•æ˜¾ç¤ºçŠ¶æ€ï¼›å¦åˆ™å»¶è¿Ÿå†è¯•ä¸€æ¬¡
      if(!isFinished()) setTimeout(attachObserver, 600);
      return;
    }
    // ç›‘å¬æŒ‰é’®è¿›å…¥å¯è§†åŒºå°±è‡ªåŠ¨ç‚¹å‡»
    io = new IntersectionObserver((entries)=>{
      if(busy) return;
      entries.forEach(e=>{ if(e.isIntersecting) clickIfVisible(); });
    }, { rootMargin: '0px', threshold: 0.01 });
    io.observe(btn);
  }

  // DOM å˜åŒ–æ—¶ï¼ŒæŒ‰é’®å¯èƒ½è¢«æ›¿æ¢ï¼Œé‡æ–°ç»‘å®šè§‚å¯Ÿå™¨
  const mo = new MutationObserver(()=>{
    if(isFinished()){ if(io) io.disconnect(); return; }
    attachObserver();
  });
  mo.observe(ROOT.parentNode || ROOT, { childList:true, subtree:true });

  // åˆå§‹åŒ–
  attachObserver();

  // å…œåº•ï¼šé¦–å±ä¸æ»¡ä¸€é¡µæ—¶ï¼Œå»¶æ—¶å°è¯•ç‚¹å‡»ä¸€æ¬¡
  setTimeout(clickIfVisible, 400);
})();
</script>


        <style>
          .cf-manage-pannel[data-v-34921c7c]{width:80%!important;height:80%!important}
          .cf-article-author:hover{color:var(--heo-card-bg)!important}
          #cf-more:hover{background:var(--heo-lighttext)!important;color:var(--heo-card-bg)!important}
        </style>

      </div>
    </main>

    <footer th:replace="~{modules/footer}"/>
    <script th:if="${theme.config.other.bubbleEnable}" async data-pjax th:src="${assets_link + '/libs/canvas/bubble.js'}"></script>
  </div>
</th:block>
</html>
<script data-pjax id="fcircle-avatar-fix-v10">
(function () {
  const API  = 'https://fcircle.oortaka.top/all';   // change to same-origin proxy if CORS blocks
  const ROOT = document.querySelector('#hexo-circle-of-friends-root') || document;
  const SELF = location.hostname;
  const isPH = s => /(?:^|\/)404s?\.(?:gif|png|jpe?g|webp)(?:$|\?)/i.test((s||''));

  // Never-fail inline SVG
  const DEFAULT_SVG =
    'data:image/svg+xml;utf8,' +
    '<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64">' +
    '<rect width="100%" height="100%" rx="12" ry="12" fill="#2b2b2b"/>' +
    '<circle cx="32" cy="24" r="12" fill="#555"/>' +
    '<rect x="14" y="40" width="36" height="14" rx="7" ry="7" fill="#555"/>' +
    '</svg>';

  const googleIcon = host => 'https://www.google.com/s2/favicons?sz=64&domain=' + host;

  function findCardFor(img) {
    // Generic: walk up to a reasonable container
    let el = img;
    for (let i=0; i<6 && el; i++) {
      if (el.matches && (el.matches('article, li, section') || (el.tagName === 'DIV' && el.children && el.children.length > 2))) {
        return el;
      }
      el = el.parentElement;
    }
    return img.parentElement || img;
  }

  function extractExternalHostFromLink(a) {
    try {
      const u = new URL(a.getAttribute('href'), location.href);
      if (u.hostname && u.hostname !== SELF) return u.hostname;
      const KEYS = ['url','u','link','to','target','jump','redirect','dest','destination'];
      for (const k of KEYS) {
        const raw = u.searchParams.get(k);
        if (!raw) continue;
        try { const h = new URL(raw, location.href).hostname; if (h && h !== SELF) return h; } catch {}
        try {
          const dec = decodeURIComponent(raw);
          try {
            const b64 = atob(dec.replace(/_/g,'/').replace(/-/g,'+'));
            const h = new URL(b64, location.href).hostname; if (h && h !== SELF) return h;
          } catch {}
          try {
            const h2 = new URL(dec, location.href).hostname; if (h2 && h2 !== SELF) return h2;
          } catch {}
        } catch {}
      }
    } catch {}
    return null;
  }

  function detectHost(card) {
    if (!card) return null;
    const as = card.querySelectorAll('a[href]');
    for (const a of as) {
      const host = extractExternalHostFromLink(a);
      if (host) return host;
    }
    const nodes = [card, ...card.querySelectorAll('*')];
    for (const el of nodes) {
      if (!el.attributes) continue;
      for (const attr of el.attributes) {
        const val = String(attr.value || '');
        const urls = val.match(/https?:\/\/[^\s"'<>)]+/ig);
        if (urls) {
          for (const raw of urls) {
            try {
              const h = new URL(raw, location.href).hostname;
              if (h && h !== SELF) return h;
            } catch {}
          }
        }
      }
    }
    try {
      const m = String(card.outerHTML||'').match(/https?:\/\/[^\s"'<>)]+/i);
      if (m) {
        const h = new URL(m[0], location.href).hostname;
        if (h && h !== SELF) return h;
      }
    } catch {}
    return null;
  }

  function apply(img, url) {
    img.style.objectFit = img.style.objectFit || 'cover';
    img.referrerPolicy = 'no-referrer';
    img.loading = 'eager';
    img.decoding = 'async';
    img.onerror = function () {
      if (img.dataset.fcircleErr !== '1') {
        img.dataset.fcircleErr = '1';
        img.src = DEFAULT_SVG;
      }
    };
    img.src = url.startsWith('data:')
      ? url
      : url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
  }

  let MAP_BY_HOST   = null; // host -> avatar
  let MAP_BY_AUTHOR = null; // author -> avatar
  async function ensureMaps() {
    if (MAP_BY_HOST && MAP_BY_AUTHOR) return;
    try {
      const res = await fetch(API, { cache: 'no-store', mode: 'cors' });
      const data = await res.json();
      const list = Array.isArray(data?.article_data) ? data.article_data : [];
      MAP_BY_HOST = new Map();
      MAP_BY_AUTHOR = new Map();
      for (const it of list) {
        try {
          const host = new URL(it.link).hostname;
          if (host && it.avatar && !MAP_BY_HOST.has(host)) MAP_BY_HOST.set(host, it.avatar);
        } catch {}
        const author = (it.author || '').trim();
        if (author && it.avatar && !MAP_BY_AUTHOR.has(author)) MAP_BY_AUTHOR.set(author, it.avatar);
      }
    } catch (e) {
      console.warn('[friends v10] fetch failed:', e);
      MAP_BY_HOST = MAP_BY_HOST || new Map();
      MAP_BY_AUTHOR = MAP_BY_AUTHOR || new Map();
    }
  }

  function findAuthorText(card) {
    // ä¼˜å…ˆå¸¸è§ç±»å
    let el = card.querySelector?.('.cf-article-author, .cf-author, .post-author, [class*="author"]');
    if (el && el.textContent) return el.textContent.trim();
    // å…œåº•ï¼šå°è¯•åœ¨å¡ç‰‡ä¸­æ‰¾åˆ°ä¸ API ä¸­ author åç§°åŒ¹é…çš„æ–‡æœ¬
    if (MAP_BY_AUTHOR && MAP_BY_AUTHOR.size) {
      const txt = (card.innerText || '').trim();
      for (const name of MAP_BY_AUTHOR.keys()) {
        if (name && txt.includes(name)) return name;
      }
    }
    return null;
  }

  async function fixOnce(scope) {
    await ensureMaps();

    const box  = scope || ROOT;
    try {
      if (window.lazyLoadInstance?.update) {
        window.lazyLoadInstance.update();
        window.lazyLoadInstance.loadAll && window.lazyLoadInstance.loadAll();
      }
    } catch {}

    const imgs = box.querySelectorAll('img');
    imgs.forEach(img => {
      const cur = img.getAttribute('src') || '';
      if (!isPH(cur)) return;

      // 1) åç«¯å·²ç»å†™äº†çœŸå®åœ°å€
      let real =
        img.getAttribute('data-lazy-src') ||
        img.getAttribute('data-src') ||
        img.getAttribute('data-original');

      // 2) ç”¨ä½œè€…åæ˜ å°„
      if (!real) {
        const card   = findCardFor(img);
        const author = findAuthorText(card);
        if (author && MAP_BY_AUTHOR.has(author)) {
          real = MAP_BY_AUTHOR.get(author);
        }

        // 3) å†ç”¨ host æ˜ å°„
        if (!real) {
          const host = detectHost(card);
          if (host) real = MAP_BY_HOST.get(host) || googleIcon(host);
        }

        // 4) æœ€åå…œåº•
        if (!real) real = DEFAULT_SVG;
      }

      apply(img, real);
    });
  }

  function init() {
    fixOnce();
    document.addEventListener('pjax:complete', () => setTimeout(fixOnce, 0));
    const mo = new MutationObserver(muts => {
      if (muts.some(m => m.addedNodes && m.addedNodes.length)) fixOnce();
    });
    mo.observe(ROOT, { childList: true, subtree: true });
  }

  if (document.readyState !== 'loading') init();
  else document.addEventListener('DOMContentLoaded', init, { once: true });
})();
</script>