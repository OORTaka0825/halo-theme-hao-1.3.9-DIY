<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{modules/layouts/layout :: layout(content = ~{::content}, htmlType = 'fcircle',title = ${singlePage.spec.title + ' | ' + site.title}, head = ~{::head} )}">
<th:block th:fragment="head">
  <!-- OGï¼šä¼˜å…ˆä¸»é¢˜è®¾ç½®ï¼Œå†å›è½é¡µé¢å­—æ®µ -->
  <th:block th:replace="~{modules/common/open-graph :: open-graph(
    _title    = ${ !#strings.isEmpty(theme.config.fcircle.bigTitle) ? theme.config.fcircle.bigTitle
                  : (!#strings.isEmpty(theme.config.fcircle.title) ? theme.config.fcircle.title : singlePage.spec.title) },
    _permalink= ${ singlePage.status.permalink },
    _cover    = ${
                    !#strings.isEmpty(theme.config.fcircle.backgroundImg) ? theme.config.fcircle.backgroundImg
                    : (!#strings.isEmpty(theme.config.fcircle.background) ? theme.config.fcircle.background
                    : (!#strings.isEmpty(theme.config.fcircle.bg) ? theme.config.fcircle.bg : singlePage.spec.cover))
                 },
    _excerpt  = ${
                    !#strings.isEmpty(theme.config.fcircle.detail) ? theme.config.fcircle.detail
                    : (!#strings.isEmpty(theme.config.fcircle.description) ? theme.config.fcircle.description
                    : (!#strings.isEmpty(theme.config.fcircle.desc) ? theme.config.fcircle.desc : singlePage.status.excerpt))
                 },
    _type     = 'website'
  )}"></th:block>
</th:block>

<th:block th:fragment="content">
  <div class="page" id="body-wrap">

    <!-- é¡¶éƒ¨å¯¼èˆªæ ‡é¢˜ -->
    <header class="not-top-img" id="page-header">
      <nav th:replace="~{modules/nav :: nav(
        title = ${ !#strings.isEmpty(theme.config.fcircle.bigTitle) ? theme.config.fcircle.bigTitle
                  : (!#strings.isEmpty(theme.config.fcircle.title) ? theme.config.fcircle.title : singlePage.spec.title) }
      )}"></nav>
    </header>

    <main class="layout hide-aside" id="content-inner">
      <div id="page">

        <!-- å¤´å›¾ç»„ä»¶ï¼šèƒŒæ™¯/å°æ ‡é¢˜/å¤§æ ‡é¢˜/æè¿° -->
        <div th:replace="~{macro/author-content :: author-content(
          background = ${
                          !#strings.isEmpty(theme.config.fcircle.backgroundImg) ? theme.config.fcircle.backgroundImg
                          : (!#strings.isEmpty(theme.config.fcircle.background) ? theme.config.fcircle.background
                          : (!#strings.isEmpty(theme.config.fcircle.bg) ? theme.config.fcircle.bg : singlePage.spec.cover))
                        },
          smallTitle = ${ !#strings.isEmpty(theme.config.fcircle.smallTitle) ? theme.config.fcircle.smallTitle
                        : (!#strings.isEmpty(theme.config.fcircle.subTitle) ? theme.config.fcircle.subTitle
                        : (!#strings.isEmpty(theme.config.fcircle.subtitle) ? theme.config.fcircle.subtitle : 'å‹é“¾')) },
          bigTitle   = ${ !#strings.isEmpty(theme.config.fcircle.bigTitle) ? theme.config.fcircle.bigTitle
                        : (!#strings.isEmpty(theme.config.fcircle.title) ? theme.config.fcircle.title : singlePage.spec.title) },
          detail     = ${
                          !#strings.isEmpty(theme.config.fcircle.detail) ? theme.config.fcircle.detail
                          : (!#strings.isEmpty(theme.config.fcircle.description) ? theme.config.fcircle.description
                          : (!#strings.isEmpty(theme.config.fcircle.desc) ? theme.config.fcircle.desc : singlePage.spec.excerpt.raw))
                        },
          buttonUrl  = ${ !#strings.isEmpty(theme.config.fcircle.buttonUrl) ? theme.config.fcircle.buttonUrl : site.url },
          buttonTitle= ${ !#strings.isEmpty(theme.config.fcircle.buttonTitle) ? theme.config.fcircle.buttonTitle : 'éƒ¨ç½²é¡¹ç›®' }
        )}"></div>

        <!-- ğŸ£ é’“é±¼ -->
        <th:block th:if="${theme.config.fcircle.fcircleRandomFriendsEnable}">
          <div class="title-h2-a">
            <div class="title-h2-a-left">
              <h2 style="padding-top:0;margin:.6rem 0 .6rem">ğŸ£ é’“é±¼</h2>
              <a class="random-post-start" href="javascript:fetchRandomPost();">
                <i class="haofont hao-icon-arrow-rotate-right"></i>
              </a>
            </div>
            <div th:if="${not #strings.isEmpty(theme.config.link.linksUrl)}" class="title-h2-a-right">
              <a class="random-post-all" th:href="${theme.config.link.linksUrl}">å…¨éƒ¨å‹é“¾</a>
            </div>
          </div>
          <div id="random-post"></div>
          <script>
            var fdataUser = {
              apiurl: "[(${theme.config.fcircle.apiurl})]",
              defaultFish: 500,
              hungryFish: 500,
            };
          </script>
          <script th:src="${assets_link + '/libs/moments/random-friends-post.js'}"></script>
        </th:block>

        <!-- ğŸŸ é±¼å¡˜ -->
        <div class="title-h2-a">
          <div class="title-h2-a-left">
            <h2 style="padding-top:0;margin:.6rem 0 .6rem">ğŸŸ é±¼å¡˜</h2>
          </div>
          <div class="title-h2-a-right"><span>ä»¥ä¸‹å†…å®¹è‡ªåŠ¨ç”Ÿæˆï¼Œæœªç»å®¡æ ¸</span></div>
        </div>

        <div id="hexo-circle-of-friends-root"></div>
        <script>
          var UserConfig = {
            private_api_url: "[(${theme.config.fcircle.apiurl})]",  // è¿™é‡Œå¡«çº¯åŸºå€ï¼Œå¦‚ https://hao-yutang.vercel.app æˆ– /api
            page_turning_number: 12,
            error_img: "https://sdn.geekzu.org/avatar/57d8260dfb55501c37dde588e7c3852c",
            sort_rule: "created"
          };
        </script>
        <link rel="stylesheet" th:href="${assets_link + '/libs/moments/heoMainColor.css'}">
        <script th:src="${assets_link + '/libs/moments/app.min.js'}"></script>
        <script th:src="${assets_link + '/libs/moments/bundle.js'}"></script>

        <style>
          .cf-manage-pannel[data-v-34921c7c]{width:80%!important;height:80%!important}
          .cf-article-author:hover{color:var(--heo-card-bg)!important}
          #cf-more:hover{background:var(--heo-lighttext)!important;color:var(--heo-card-bg)!important}
        </style>

      </div>
    </main>

    <footer th:replace="~{modules/footer}"/>
    <script th:if="${theme.config.other.bubbleEnable}" async data-pjax th:src="${assets_link + '/libs/canvas/bubble.js'}"></script>
  </div>
</th:block>
</html>

<script data-pjax id="fcircle-infinite-scroll">
(function () {
  const ROOT = document.querySelector('#hexo-circle-of-friends-root') || document;
  let io = null;
  let lastClick = 0;
  let activeBtn = null;

  function findMoreBtn(scope = ROOT) {
    const candidates = Array.from(scope.querySelectorAll('button, a, [role="button"], .btn, .more, .load-more, .next, .cf-more, .cf-next, .fcircle-more, .fcircle-next'));
    const regexp = /(åŠ è½½æ›´å¤š|åŠ è½½|æ›´å¤š|ä¸‹ä¸€é¡µ|ä¸‹ä¸€æ‰¹|æ›´å¤šå†…å®¹|more|load)/i;
    for (const el of candidates) {
      const text = (el.textContent || '').trim();
      if (regexp.test(text)) return el;
    }
    return candidates[0] || null;
  }

  function looksDisabled(btn) {
    const t = (btn.textContent || '').trim();
    return btn.hasAttribute('disabled') ||
           btn.getAttribute('aria-disabled') === 'true' ||
           /æ²¡æœ‰|æ— æ›´å¤š|åˆ°åº•|å®Œ|æš‚æ— |å·²å…¨éƒ¨/i.test(t) ||
           /disabled|is-disabled|no-more|end/.test(btn.className);
  }

  function safeClick(btn) {
    const now = Date.now();
    if (now - lastClick < 800) return;
    lastClick = now;

    if (looksDisabled(btn)) {
      disconnect();
      return;
    }
    try { btn.click(); } catch(e) {
      btn.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true}));
    }
  }

  function observe(btn) {
    if (!btn) return;
    activeBtn = btn;

    // æç¤ºï¼šè‡ªåŠ¨åŠ è½½ç”Ÿæ•ˆæ—¶å¼±åŒ–æŒ‰é’®ï¼ˆå¦‚éœ€ä¿ç•™åŸæ ·ï¼Œå¯åˆ æ‰ä¸¤è¡Œæ ·å¼ï¼‰
    btn.style.opacity = '0.4';
    btn.style.pointerEvents = 'none';

    io = new IntersectionObserver((entries) => {
      entries.forEach(e => { if (e.isIntersecting) safeClick(btn); });
    }, { root: null, threshold: 0.01, rootMargin: '300px 0px' });

    io.observe(btn);
  }

  function disconnect() {
    if (io) { try { io.disconnect(); } catch{} io = null; }
    if (activeBtn) { activeBtn.style.opacity = ''; activeBtn.style.pointerEvents = ''; activeBtn = null; }
  }

  function init() {
    disconnect();
    const btn = findMoreBtn();
    if (btn) observe(btn);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init, { once: true });
  } else {
    init();
  }

  document.addEventListener('pjax:complete', () => setTimeout(init, 0));

  const mo = new MutationObserver((muts) => {
    if (muts.some(m => m.addedNodes && m.addedNodes.length)) {
      const stillOk = activeBtn && document.contains(activeBtn) && !looksDisabled(activeBtn);
      if (!stillOk) init();
    }
  });
  mo.observe(ROOT, { childList: true, subtree: true });

  if (!('IntersectionObserver' in window)) {
    let ticking = false;
    window.addEventListener('scroll', () => {
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(() => {
        const btn = activeBtn || findMoreBtn();
        if (btn && !looksDisabled(btn)) {
          const rect = btn.getBoundingClientRect();
          if (rect.top < window.innerHeight + 300) safeClick(btn);
        }
        ticking = false;
      });
    }, { passive: true });
  }
})();
</script>
