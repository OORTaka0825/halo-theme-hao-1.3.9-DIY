<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{modules/layouts/layout :: layout(content = ~{::content}, htmlType = 'fcircle',title = ${singlePage.spec.title + ' | ' + site.title}, head = ~{::head} )}">
<th:block th:fragment="head">
  <!-- OG：优先主题设置，再回落页面字段 -->
  <th:block th:replace="~{modules/common/open-graph :: open-graph(
    _title    = ${ !#strings.isEmpty(theme.config.fcircle.bigTitle) ? theme.config.fcircle.bigTitle
                  : (!#strings.isEmpty(theme.config.fcircle.title) ? theme.config.fcircle.title : singlePage.spec.title) },
    _permalink= ${ singlePage.status.permalink },
    _cover    = ${
                    !#strings.isEmpty(theme.config.fcircle.backgroundImg) ? theme.config.fcircle.backgroundImg
                    : (!#strings.isEmpty(theme.config.fcircle.background) ? theme.config.fcircle.background
                    : (!#strings.isEmpty(theme.config.fcircle.bg) ? theme.config.fcircle.bg : singlePage.spec.cover))
                 },
    _excerpt  = ${
                    !#strings.isEmpty(theme.config.fcircle.detail) ? theme.config.fcircle.detail
                    : (!#strings.isEmpty(theme.config.fcircle.description) ? theme.config.fcircle.description
                    : (!#strings.isEmpty(theme.config.fcircle.desc) ? theme.config.fcircle.desc : singlePage.status.excerpt))
                 },
    _type     = 'website'
  )}"></th:block>
</th:block>

<th:block th:fragment="content">
  <div class="page" id="body-wrap">

    <!-- 顶部导航标题 -->
    <header class="not-top-img" id="page-header">
      <nav th:replace="~{modules/nav :: nav(
        title = ${ !#strings.isEmpty(theme.config.fcircle.bigTitle) ? theme.config.fcircle.bigTitle
                  : (!#strings.isEmpty(theme.config.fcircle.title) ? theme.config.fcircle.title : singlePage.spec.title) }
      )}"></nav>
  

</header>

    <main class="layout hide-aside" id="content-inner">
      <div id="page">

        <!-- 头图组件：背景/小标题/大标题/描述 -->
        <div th:replace="~{macro/author-content :: author-content(
          background = ${
                          !#strings.isEmpty(theme.config.fcircle.backgroundImg) ? theme.config.fcircle.backgroundImg
                          : (!#strings.isEmpty(theme.config.fcircle.background) ? theme.config.fcircle.background
                          : (!#strings.isEmpty(theme.config.fcircle.bg) ? theme.config.fcircle.bg : singlePage.spec.cover))
                        },
          smallTitle = ${ !#strings.isEmpty(theme.config.fcircle.smallTitle) ? theme.config.fcircle.smallTitle
                        : (!#strings.isEmpty(theme.config.fcircle.subTitle) ? theme.config.fcircle.subTitle
                        : (!#strings.isEmpty(theme.config.fcircle.subtitle) ? theme.config.fcircle.subtitle : '友链')) },
          bigTitle   = ${ !#strings.isEmpty(theme.config.fcircle.bigTitle) ? theme.config.fcircle.bigTitle
                        : (!#strings.isEmpty(theme.config.fcircle.title) ? theme.config.fcircle.title : singlePage.spec.title) },
          detail     = ${
                          !#strings.isEmpty(theme.config.fcircle.detail) ? theme.config.fcircle.detail
                          : (!#strings.isEmpty(theme.config.fcircle.description) ? theme.config.fcircle.description
                          : (!#strings.isEmpty(theme.config.fcircle.desc) ? theme.config.fcircle.desc : singlePage.spec.excerpt.raw))
                        },
          buttonUrl  = ${ !#strings.isEmpty(theme.config.fcircle.buttonUrl) ? theme.config.fcircle.buttonUrl : site.url },
          buttonTitle= ${ !#strings.isEmpty(theme.config.fcircle.buttonTitle) ? theme.config.fcircle.buttonTitle : '部署项目' }
        )}"></div>

        <!-- 🎣 钓鱼 -->
        <th:block th:if="${theme.config.fcircle.fcircleRandomFriendsEnable}">
          <div class="title-h2-a">
            <div class="title-h2-a-left">
              <h2 style="padding-top:0;margin:.6rem 0 .6rem">🎣 钓鱼</h2>
              <a class="random-post-start" href="javascript:fetchRandomPost();">
                <i class="haofont hao-icon-arrow-rotate-right"></i>
              </a>
            </div>
            <div th:if="${not #strings.isEmpty(theme.config.link.linksUrl)}" class="title-h2-a-right">
              <a class="random-post-all" th:href="${theme.config.link.linksUrl}">全部友链</a>
            </div>
          </div>
          <div id="random-post"></div>
          <script>
            var fdataUser = {
              apiurl: "[(${theme.config.fcircle.apiurl})]",
              defaultFish: 500,
              hungryFish: 500,
            };
          </script>
          <script th:src="${assets_link + '/libs/moments/random-friends-post.js'}"></script>
        </th:block>

        <!-- 🐟 鱼塘 -->
        <div class="title-h2-a">
          <div class="title-h2-a-left">
            <h2 style="padding-top:0;margin:.6rem 0 .6rem">🐟 鱼塘</h2>
          </div>
          <div class="title-h2-a-right"><span>以下内容自动生成，未经审核</span></div>
        </div>

        <div id="hexo-circle-of-friends-root"></div>
        <script>
          var UserConfig = {
            private_api_url: "[(${theme.config.fcircle.apiurl})]",  // 这里填纯基址，如 https://hao-yutang.vercel.app 或 /api
            page_turning_number: 12,
            error_img: "https://sdn.geekzu.org/avatar/57d8260dfb55501c37dde588e7c3852c",
            sort_rule: "created"
          };
        </script>
        <link rel="stylesheet" th:href="${assets_link + '/libs/moments/heoMainColor.css'}">
        <script th:src="${assets_link + '/libs/moments/app.min.js'}"></script>
        <script th:src="${assets_link + '/libs/moments/bundle.js'}"></script>

        <style>
          .cf-manage-pannel[data-v-34921c7c]{width:80%!important;height:80%!important}
          .cf-article-author:hover{color:var(--heo-card-bg)!important}
          #cf-more:hover{background:var(--heo-lighttext)!important;color:var(--heo-card-bg)!important}
        </style>

      </div>
    </main>

    <footer th:replace="~{modules/footer}"/>
    <script th:if="${theme.config.other.bubbleEnable}" async data-pjax th:src="${assets_link + '/libs/canvas/bubble.js'}"></script>
  </div>
</th:block>
</html>

<!-- Friends avatar fix v8: prefer API avatar, smarter host detection (handles internal links), final inline SVG fallback -->
<script data-pjax id="fcircle-avatar-from-api-v8">
(function () {
  const API = 'https://fcircle.oortaka.top/all';  // change to same-origin proxy if CORS blocks
  const ROOT = document.querySelector('#hexo-circle-of-friends-root') || document;
  const isPH = s => /(?:^|\/)404s?\.(?:gif|png|jpe?g|webp)(?:$|\?)/i.test((s||''));
  const SELF = location.hostname;

  const DEFAULT_SVG =
    'data:image/svg+xml;utf8,' +
    '<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64">' +
    '<rect width="100%" height="100%" rx="12" ry="12" fill="#2b2b2b"/>' +
    '<circle cx="32" cy="24" r="12" fill="#555"/>' +
    '<rect x="14" y="40" width="36" height="14" rx="7" ry="7" fill="#555"/>' +
    '</svg>';

  function googleIcon(host) {
    return 'https://www.google.com/s2/favicons?sz=64&domain=' + host;
  }

  // Extract first external host from a card, even if links are internal:
  function detectHost(card) {
    if (!card) return null;

    // 1) any external <a href>
    const links = card.querySelectorAll('a[href]');
    for (const a of links) {
      try {
        const u = new URL(a.getAttribute('href'), location.href);
        if (u.hostname && u.hostname !== SELF) return u.hostname;
      } catch {}
    }

    // 2) scan descendant/own attributes that contain http(s)
    const nodes = card.querySelectorAll('*');
    const allNodes = [card, ...nodes];
    for (const el of allNodes) {
      if (!el.attributes) continue;
      for (const attr of el.attributes) {
        const val = String(attr.value || '');
        const urls = val.match(/https?:\/\/[^\s"'<>)]+/ig);
        if (urls) {
          for (const raw of urls) {
            try {
              const u = new URL(raw, location.href);
              if (u.hostname && u.hostname !== SELF) return u.hostname;
            } catch {}
          }
        }
      }
    }

    // 3) last resort: search outerHTML for http(s)
    try {
      const m = String(card.outerHTML||'').match(/https?:\/\/[^\s"'<>)]+/i);
      if (m) {
        const u = new URL(m[0], location.href);
        if (u.hostname && u.hostname !== SELF) return u.hostname;
      }
    } catch {}
    return null;
  }

  function apply(img, url) {
    img.style.objectFit = img.style.objectFit || 'cover';
    img.referrerPolicy = 'no-referrer';
    img.loading = 'eager';
    img.decoding = 'async';
    img.onerror = function () {
      if (img.dataset.fcircleErr !== '1') {
        img.dataset.fcircleErr = '1';
        img.src = DEFAULT_SVG;
      }
    };
    img.src = url.startsWith('data:')
      ? url
      : url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
  }

  let AVATAR_MAP = null; // Map host->avatar
  async function ensureMap() {
    if (AVATAR_MAP) return AVATAR_MAP;
    try {
      const res = await fetch(API, { cache: 'no-store', mode: 'cors' });
      const data = await res.json();
      const list = Array.isArray(data?.article_data) ? data.article_data : [];
      const map = new Map();
      for (const it of list) {
        try {
          const host = new URL(it.link).hostname;
          if (host && it.avatar && !map.has(host)) map.set(host, it.avatar);
        } catch {}
      }
      AVATAR_MAP = map;
    } catch (e) {
      console.warn('[friends-api v8] fetch failed:', e);
      AVATAR_MAP = new Map();
    }
    return AVATAR_MAP;
  }

  async function fixOnce(scope) {
    const box = scope || ROOT;
    try {
      if (window.lazyLoadInstance?.update) {
        window.lazyLoadInstance.update();
        window.lazyLoadInstance.loadAll && window.lazyLoadInstance.loadAll();
      }
    } catch {}

    const map = await ensureMap();
    const imgs = box.querySelectorAll('img');
    let fixed = 0;

    imgs.forEach(img => {
      const cur = img.getAttribute('src') || '';
      if (!isPH(cur)) return;

      // prefer data-lazy real url
      let real =
        img.getAttribute('data-lazy-src') ||
        img.getAttribute('data-src') ||
        img.getAttribute('data-original');

      if (!real) {
        const card = img.closest('.cf-card, .cf-item, article, li, div');
        const host = detectHost(card);
        if (host) {
          real = map.get(host) || googleIcon(host);
        } else {
          real = DEFAULT_SVG;
        }
      }

      apply(img, real);
      fixed++;
    });

    // console.log('[friends-avatar v8] replaced:', fixed, 'map size:', (AVATAR_MAP&&AVATAR_MAP.size));
  }

  function init() {
    fixOnce();
    document.addEventListener('pjax:complete', () => setTimeout(fixOnce, 0));
    const mo = new MutationObserver(muts => {
      if (muts.some(m => m.addedNodes && m.addedNodes.length)) fixOnce();
    });
    mo.observe(ROOT, { childList: true, subtree: true });
  }

  if (document.readyState !== 'loading') init();
  else document.addEventListener('DOMContentLoaded', init, { once: true });
})();
</script>
