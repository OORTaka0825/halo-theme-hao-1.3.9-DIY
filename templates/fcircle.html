<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{modules/layouts/layout :: layout(content = ~{::content}, htmlType = 'fcircle',title = ${singlePage.spec.title + ' | ' + site.title}, head = ~{::head} )}">
<th:block th:fragment="head">
  <!-- OG：优先主题设置，再回落页面字段 -->
  <th:block th:replace="~{modules/common/open-graph :: open-graph(
    _title    = ${ !#strings.isEmpty(theme.config.fcircle.bigTitle) ? theme.config.fcircle.bigTitle
                  : (!#strings.isEmpty(theme.config.fcircle.title) ? theme.config.fcircle.title : singlePage.spec.title) },
    _permalink= ${ singlePage.status.permalink },
    _cover    = ${
                    !#strings.isEmpty(theme.config.fcircle.backgroundImg) ? theme.config.fcircle.backgroundImg
                    : (!#strings.isEmpty(theme.config.fcircle.background) ? theme.config.fcircle.background
                    : (!#strings.isEmpty(theme.config.fcircle.bg) ? theme.config.fcircle.bg : singlePage.spec.cover))
                 },
    _excerpt  = ${
                    !#strings.isEmpty(theme.config.fcircle.detail) ? theme.config.fcircle.detail
                    : (!#strings.isEmpty(theme.config.fcircle.description) ? theme.config.fcircle.description
                    : (!#strings.isEmpty(theme.config.fcircle.desc) ? theme.config.fcircle.desc : singlePage.status.excerpt))
                 },
    _type     = 'website'
  )}"></th:block>
</th:block>

<th:block th:fragment="content">
  <div class="page" id="body-wrap">

    <!-- 顶部导航标题 -->
    <header class="not-top-img" id="page-header">
      <nav th:replace="~{modules/nav :: nav(
        title = ${ !#strings.isEmpty(theme.config.fcircle.bigTitle) ? theme.config.fcircle.bigTitle
                  : (!#strings.isEmpty(theme.config.fcircle.title) ? theme.config.fcircle.title : singlePage.spec.title) }
      )}"></nav>
  

</header>

    <main class="layout hide-aside" id="content-inner">
      <div id="page">

        <!-- 头图组件：背景/小标题/大标题/描述 -->
        <div th:replace="~{macro/author-content :: author-content(
          background = ${
                          !#strings.isEmpty(theme.config.fcircle.backgroundImg) ? theme.config.fcircle.backgroundImg
                          : (!#strings.isEmpty(theme.config.fcircle.background) ? theme.config.fcircle.background
                          : (!#strings.isEmpty(theme.config.fcircle.bg) ? theme.config.fcircle.bg : singlePage.spec.cover))
                        },
          smallTitle = ${ !#strings.isEmpty(theme.config.fcircle.smallTitle) ? theme.config.fcircle.smallTitle
                        : (!#strings.isEmpty(theme.config.fcircle.subTitle) ? theme.config.fcircle.subTitle
                        : (!#strings.isEmpty(theme.config.fcircle.subtitle) ? theme.config.fcircle.subtitle : '友链')) },
          bigTitle   = ${ !#strings.isEmpty(theme.config.fcircle.bigTitle) ? theme.config.fcircle.bigTitle
                        : (!#strings.isEmpty(theme.config.fcircle.title) ? theme.config.fcircle.title : singlePage.spec.title) },
          detail     = ${
                          !#strings.isEmpty(theme.config.fcircle.detail) ? theme.config.fcircle.detail
                          : (!#strings.isEmpty(theme.config.fcircle.description) ? theme.config.fcircle.description
                          : (!#strings.isEmpty(theme.config.fcircle.desc) ? theme.config.fcircle.desc : singlePage.spec.excerpt.raw))
                        },
          buttonUrl  = ${ !#strings.isEmpty(theme.config.fcircle.buttonUrl) ? theme.config.fcircle.buttonUrl : site.url },
          buttonTitle= ${ !#strings.isEmpty(theme.config.fcircle.buttonTitle) ? theme.config.fcircle.buttonTitle : '部署项目' }
        )}"></div>

        <!-- 🎣 钓鱼 -->
        <th:block th:if="${theme.config.fcircle.fcircleRandomFriendsEnable}">
          <div class="title-h2-a">
            <div class="title-h2-a-left">
              <h2 style="padding-top:0;margin:.6rem 0 .6rem">🎣 钓鱼</h2>
              <a class="random-post-start" href="javascript:fetchRandomPost();">
                <i class="haofont hao-icon-arrow-rotate-right"></i>
              </a>
            </div>
            <div th:if="${not #strings.isEmpty(theme.config.link.linksUrl)}" class="title-h2-a-right">
              <a class="random-post-all" th:href="${theme.config.link.linksUrl}">全部友链</a>
            </div>
          </div>
          <div id="random-post"></div>
          <script>
            var fdataUser = {
              apiurl: "[(${theme.config.fcircle.apiurl})]",
              defaultFish: 500,
              hungryFish: 500,
            };
          </script>
          <script th:src="${assets_link + '/libs/moments/random-friends-post.js'}"></script>
        </th:block>

        <!-- 🐟 鱼塘 -->
        <div class="title-h2-a">
          <div class="title-h2-a-left">
            <h2 style="padding-top:0;margin:.6rem 0 .6rem">🐟 鱼塘</h2>
          </div>
          <div class="title-h2-a-right"><span>以下内容自动生成，未经审核</span></div>
        </div>

        <div id="hexo-circle-of-friends-root"></div>
        <script>
          var UserConfig = {
            private_api_url: "[(${theme.config.fcircle.apiurl})]",  // 这里填纯基址，如 https://hao-yutang.vercel.app 或 /api
            page_turning_number: 9999,
            error_img: "https://sdn.geekzu.org/avatar/57d8260dfb55501c37dde588e7c3852c",
            sort_rule: "created"
          };
        </script>
        <link rel="stylesheet" th:href="${assets_link + '/libs/moments/heoMainColor.css'}">
        <script th:src="${assets_link + '/libs/moments/app.min.js'}"></script>
        <script th:src="${assets_link + '/libs/moments/bundle.js'}"></script>

        <style>
          .cf-manage-pannel[data-v-34921c7c]{width:80%!important;height:80%!important}
          .cf-article-author:hover{color:var(--heo-card-bg)!important}
          #cf-more:hover{background:var(--heo-lighttext)!important;color:var(--heo-card-bg)!important}
        </style>

      </div>
    </main>

    <footer th:replace="~{modules/footer}"/>
    <script th:if="${theme.config.other.bubbleEnable}" async data-pjax th:src="${assets_link + '/libs/canvas/bubble.js'}"></script>
  </div>
</th:block>
</html>



<script data-pjax id="fcircle-autoload-all-with-endtip">
(function(){
  var draining = false;

  function findBtn(){
    var btn = document.querySelector('#cf-more, .cf-more, .moments-more');
    if (btn) return btn;
    var scope = document.querySelector('#hexo-circle-of-friends-root') || document;
    var cands = scope.querySelectorAll('button, a, div');
    for (var i=0;i<cands.length;i++){
      var el = cands[i];
      var t = (el.textContent||'').trim();
      if (t === '∞' || /加载更多|载入更多|更多|Load\s*more/i.test(t)) return el;
    }
    return null;
  }

  function isDone(btn){
    if (!btn) return true;
    var t = (btn.textContent||'').trim();
    var cls = btn.className||'';
    return btn.disabled ||
           btn.getAttribute('aria-disabled') === 'true' ||
           /没有|无更多|到底|完成|已全部|暂无|完毕/i.test(t) ||
           /(no-more|nomore|end|disabled)/i.test(cls) ||
           btn.style.visibility === 'hidden';
  }

  function safeClick(btn){
    try { btn.click(); }
    catch(e){
      try{
        btn.dispatchEvent(new MouseEvent('click', {bubbles:true, cancelable:true}));
      }catch(_){}
    }
  }

  function waitRender(timeout){
    return new Promise(function(resolve){
      var settled = false;
      var root = document.querySelector('#hexo-circle-of-friends-root') || document.body;
      var mo = new MutationObserver(function(muts){
        if (muts.some(function(m){ return m.addedNodes && m.addedNodes.length; })){
          if (!settled){ settled = true; mo.disconnect(); resolve(true); }
        }
      });
      mo.observe(root, {childList:true, subtree:true});
      setTimeout(function(){ if(!settled){ settled=true; mo.disconnect(); resolve(false);} }, timeout||900);
    });
  }

  function showEndTip(btn){
    // 如果原主题就是用按钮显示“∞ / 一切皆有尽头”，复用它
    if (btn){
      btn.style.display = '';
      btn.setAttribute('disabled','true');
      btn.classList.add('no-more');
      btn.style.pointerEvents = 'none';
      btn.textContent = '一切皆有尽头';
      return;
    }
    // 否则创建一个样式接近的提示
    var tip = document.getElementById('cf-end-tip');
    if (!tip){
      tip = document.createElement('div');
      tip.id = 'cf-end-tip';
      tip.textContent = '一切皆有尽头';
      tip.style.cssText = 'margin:16px auto 0; width:max-content; padding:8px 16px; border-radius:999px; opacity:.7; background:var(--heo-card-bg, rgba(255,255,255,.06)); color:var(--heo-font-color, #c9d1d9);';
      var parent = (document.querySelector('#cf-more')||document.querySelector('.cf-more'))?.parentNode
                 || document.querySelector('.cf-container,.cf-body,.friend-wrapper,main,body');
      parent && parent.appendChild(tip);
    }
  }

  async function drain(){
    if (draining) return;
    draining = true;
    try{
      var tries = 0;
      while(tries < 200){
        var btn = findBtn();
        if (isDone(btn)){ showEndTip(btn); break; }
        // 点击期间先隐藏，避免闪烁
        if (btn) btn.style.display = 'none';
        safeClick(btn);
        tries++;
        await waitRender(1100);
        var btn2 = findBtn();
        if (isDone(btn2)){ showEndTip(btn2); break; }
      }
    } finally {
      draining = false;
    }
  }

  function startWhenReady(){
    var checks = 0;
    var timer = setInterval(function(){
      checks++;
      var btn = findBtn();
      if (btn){
        clearInterval(timer);
        drain();
      }
      if (checks > 80) clearInterval(timer);
    }, 250);
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', startWhenReady, {once:true});
  } else {
    setTimeout(startWhenReady, 30);
  }
})();
</script>

