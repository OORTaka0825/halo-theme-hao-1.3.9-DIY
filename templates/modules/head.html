<!-- 公共的 head 部分，可以定义部分 links,scripts,styles -->
<th:block th:fragment="head(htmlType)">
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width,initial-scale=1" name="viewport">
    <meta content="telephone=no" name="format-detection">
    <meta content="var(--heo-card-bg)" name="theme-color">
    <title th:text="${siteTitle}"></title>
    <link rel="shortcut icon"
          th:href="@{${#strings.isEmpty(site.favicon) ? assets_link + '/images/hao-logo.jpg' : site.favicon}}"/>
    <script src="/themes/theme-hao/assets/libs/jquery.min.js"></script>

    <!-- Fancybox 图片灯箱效果，仅文章页加载（增量插入） -->
    <link th:if="${htmlType == 'post'}"
          rel="stylesheet"
          th:href="@{/assets/libs/fancybox@5.3.7/jquery.fancybox.min.css}" />

    <script th:if="${htmlType == 'post'}"
            data-pjax
            th:src="@{/assets/libs/fancybox@5.3.7/jquery.fancybox.min.js}"></script>

    <!-- 图片点击放大初始化脚本（增量插入） -->
<!-- 图片点击放大初始化脚本（拦截 IMG 与含图 A；动态建组；首点按需加载；等待库就绪；PJAX 兼容） -->
<script th:if="${htmlType == 'post'}" data-pjax>
(function () {
  function ensureFancybox() {
    if (window.jQuery && (window.jQuery.fancybox || (window.jQuery.fn && window.jQuery.fn.fancybox))) {
      return Promise.resolve();
    }
    var cssHref = "[[@{/assets/libs/fancybox@5.3.7/jquery.fancybox.min.css}]]";
    var jsSrc  = "[[@{/assets/libs/fancybox@5.3.7/jquery.fancybox.min.js}]]";

    if (!document.querySelector('link[href*="jquery.fancybox.min.css"]')) {
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = cssHref;
      document.head.appendChild(link);
    }
    if (window.__fancyboxLoadingPromise) return window.__fancyboxLoadingPromise;

    window.__fancyboxLoadingPromise = new Promise(function (resolve, reject) {
      var s = document.createElement('script');
      s.src = jsSrc;
      s.onload = function(){ resolve(); };
      s.onerror = reject;
      document.head.appendChild(s);
    });
    return window.__fancyboxLoadingPromise;
  }

  function waitForFancyboxReady(timeoutMs){
    timeoutMs = timeoutMs || 3000;
    var start = performance.now();
    return new Promise(function(resolve, reject){
      (function check(){
        var ok = window.jQuery && (window.jQuery.fancybox || (window.jQuery.fn && window.jQuery.fn.fancybox));
        if (ok) return resolve();
        if (performance.now() - start > timeoutMs) return reject(new Error('fancybox not ready'));
        requestAnimationFrame(check);
      })();
    });
  }

  function getSrcFromImgOrAnchor(el){
    if (!el) return null;
    if (el.tagName === 'IMG') {
      return el.getAttribute('data-lazy-src') || el.getAttribute('data-src') || el.getAttribute('src');
    }
    if (el.tagName === 'A') {
      // prefer href; fall back to contained img
      var href = el.getAttribute('href');
      if (href) return href;
      var im = el.querySelector('img');
      if (im) return getSrcFromImgOrAnchor(im);
    }
    return null;
  }

  function isImageLink(url){
    if (!url) return false;
    return /\.(jpe?g|png|webp|gif|bmp|svg)(\?.*)?$/i.test(url) || url.startsWith('blob:') || url.startsWith('data:image');
  }

  function onDocClick(e){
    // 1) 目标可能是 IMG，也可能是包含 IMG 的 A，或者直接是指向图片的 A
    var img = e.target.closest && e.target.closest('#article-container img');
    var a   = e.target.closest && e.target.closest('#article-container a');

    // 忽略特定类
    if (img && (img.classList.contains('no-lightbox') || img.classList.contains('avatar') || img.classList.contains('emoji'))) return;

    // 判断是否是我们要接管的点击
    var candidate = null;
    if (img) {
      candidate = img;
    } else if (a) {
      // 如果是 A，必须是含图或直链图片
      if (a.querySelector('img')) candidate = a;
      else {
        var href = a.getAttribute('href');
        if (isImageLink(href)) candidate = a;
      }
    }
    if (!candidate) return;

    // 接管，避免默认跳转/PJAX
    e.preventDefault();
    e.stopPropagation();

    var container = document.querySelector('#article-container');
    if (!container) return;

    // 2) 构建当前文章的图片组（按 DOM 顺序）
    var imgs = Array.prototype.slice.call(container.querySelectorAll('img:not(.no-lightbox):not(.avatar):not(.emoji)'));
    var items = imgs.map(function(im){
      return { src: getSrcFromImgOrAnchor(im), opts: { caption: im.getAttribute('alt') || '' } };
    }).filter(function(it){ return !!it.src; });

    // 找到起始索引：如果点的是 A，则找其内部 IMG 或 href 对应的 src
    var startSrc = getSrcFromImgOrAnchor(candidate);
    var startIndex = Math.max(0, items.findIndex(function(it){ return it.src === startSrc; }));
    if (startIndex < 0) startIndex = 0;

    // 3) 确保库加载并就绪，再打开
    ensureFancybox()
      .then(function(){ return waitForFancyboxReady(4000); })
      .then(function(){
        var $ = window.jQuery;
        $.fancybox.defaults.hash = false;
        $.fancybox.defaults.backFocus = false;
        $.fancybox.open(items, {
          loop: true,
          protect: true,
          transitionEffect: 'slide',
          hash: false,
          backFocus: false
        }, startIndex);
      })
      .catch(function(err){ console && console.warn && console.warn('[fancybox]', err); });
  }

  // 捕获阶段优先接管
  document.addEventListener('click', onDocClick, true);

  // PJAX 完成时预加载样式（非必须）
  ['pjax:complete','pjax:end','pjax:success'].forEach(function(ev){
    document.addEventListener(ev, function(){
      if (!document.querySelector('link[href*="jquery.fancybox.min.css"]')) {
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = "[[@{/assets/libs/fancybox@5.3.7/jquery.fancybox.min.css}]]";
        document.head.appendChild(link);
      }
    }, false);
  });
})();
</script>
<script th:src="${assets_link + '/js/heo.js' + theme_version}"></script>

    <script th:src="${assets_link + '/js/halo.js' + theme_version}"></script>

    <link rel="stylesheet" th:href="${assets_link + '/zhheo/zhheoblog.css' + theme_version}">

    <link rel="stylesheet" th:href="${assets_link + '/zhheo/custom.css' + theme_version}">

    <link rel="stylesheet" th:href="${assets_link + '/zhheo/commentBarrage.css'}">

    <style th:if="${theme.config.other.scrollbarLinearGradientEnable}">
        *::-webkit-scrollbar-thumb {
            background-color: var(--heo-main);
            background-image: -webkit-linear-gradient(45deg,rgba(255,255,255,.4) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.4) 50%,rgba(255,255,255,.4) 75%,transparent 75%,transparent);
            border-radius: 2em
        }
    </style>

    <!-- swiper 在瞬间滚动时会使用 -->
    <link th:if="${theme.config.top.moment}" rel="stylesheet" href="/themes/theme-hao/assets/libs/swiper-bundle.min.css"/>

    <!-- 右下角通知 -->
    <link href="/themes/theme-hao/assets/libs/snackbar.min.css"
          media="print"
          onload='this.media="all"'
          rel="stylesheet"
    />

    <!-- 代码块自动识别语言 -->
    <th:block th:replace="~{modules/common/code}"/>
    <!--  代码块-->
    <th:block th:replace="~{macro/prism-code}"/>

    <!-- 页脚内容-样式一 -->
    <th:block th:replace="~{modules/common/footer-style-one}"/>

    <script>
        (win => {
            win.saveToLocal = {
                set: function setWithExpiry(key, value, ttl) {
                    if (ttl === 0) return
                    const now = new Date()
                    const expiryDay = ttl * 86400000
                    const item = {
                        value: value,
                        expiry: now.getTime() + expiryDay,
                    }
                    localStorage.setItem(key, JSON.stringify(item))
                },

                get: function getWithExpiry(key) {
                    const itemStr = localStorage.getItem(key)

                    if (!itemStr) {
                        return undefined
                    }
                    const item = JSON.parse(itemStr)
                    const now = new Date()

                    if (now.getTime() > item.expiry) {
                        localStorage.removeItem(key)
                        return undefined
                    }
                    return item.value
                }
            }

            win.getScript = url => new Promise((resolve, reject) => {
                const script = document.createElement('script')
                script.src = url
                script.async = true
                script.onerror = reject
                script.onload = script.onreadystatechange = function () {
                    const loadState = this.readyState
                    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
                    script.onload = script.onreadystatechange = null
                    resolve()
                }
                document.head.appendChild(script)
            })

            win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
                const link = document.createElement('link')
                link.rel = 'stylesheet'
                link.href = url
                if (id) link.id = id
                link.onerror = reject
                link.onload = link.onreadystatechange = function() {
                    const loadState = this.readyState
                    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
                    link.onload = link.onreadystatechange = null
                    resolve()
                }
                document.head.appendChild(link)
            })

            win.activateDarkMode = function () {
                document.documentElement.setAttribute('data-theme', 'dark')
                document.documentElement.classList.add('color-scheme-dark')
                heo.initThemeColor()
            }
            win.activateLightMode = function () {
                document.documentElement.setAttribute('data-theme', 'light')
                document.documentElement.classList.remove('color-scheme-dark')
                heo.initThemeColor()
            }
            const t = saveToLocal.get('theme')

            const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
            const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
            const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
            const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

            if (t === undefined) {
                if (isLightMode) activateLightMode()
                else if (isDarkMode) activateDarkMode()
                else if (isNotSpecified || hasNoSupport) {
                    const now = new Date()
                    const hour = now.getHours()
                    const isNight = hour <= 6 || hour >= 18
                    isNight ? activateDarkMode() : activateLightMode()
                }
                window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
                    if (saveToLocal.get('theme') === undefined) {
                        e.matches ? activateDarkMode() : activateLightMode()
                    }
                })
            } else if (t === 'light') activateLightMode()
            else activateDarkMode()

            if("[[${theme.config.style.colorScheme}]]" === 'dark')
                activateDarkMode()
            if("[[${theme.config.style.colorScheme}]]" === 'light')
                activateLightMode()

            const asideStatus = saveToLocal.get('aside-status')
            if (asideStatus !== undefined) {
                if (asideStatus === 'hide') {
                    document.documentElement.classList.add('hide-aside')
                } else {
                    document.documentElement.classList.remove('hide-aside')
                }
            }
        })(window)
    </script>

    <!-- 动态加载条 -->
    <script data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"
            th:src="${assets_link + '/libs/pace/pace.min.js'}"
            th:if="${theme.config.other.loadingBoxs.loadProgressBar}">
    </script>

    <!-- 复制 https://githubfast.com/zenorocha/clipboard.js -->
    <script th:src="${assets_link + '/libs/clipboard/clipboard.min.js'}"></script>

    <!-- 关于统计-->
    <script th:if="${#strings.contains(theme.config.about.widgets,'statistics-map')}" th:src="${assets_link + '/libs/countup/countup.js'}"></script>

    <!-- 小板报 -->
    <th:block th:if="${not #strings.isEmpty(theme.config.sidebar.welcome.key)}">
        <script defer th:if="${#strings.contains(theme.config.sidebar.widgetss.indexWidgets,'welcome') ||
            #strings.contains(theme.config.sidebar.widgetss.postWidgets,'welcome') ||
            #strings.contains(theme.config.sidebar.widgetss.tagWidgets,'welcome') ||
            #strings.contains(theme.config.sidebar.widgetss.categoryWidgets,'welcome')}"
                th:src="${assets_link + '/libs/welcome/welcome.js'}"></script>
    </th:block>

    <!-- icon图标 -->
    <link rel="stylesheet" th:href="'https://cdn.cbd.int/hao-theme-static@'+${theme.spec.version}+'/icon/iconfont.css'">

    <th:block th:replace="~{modules/variables/site-config :: site-config}" />


</th:block>
