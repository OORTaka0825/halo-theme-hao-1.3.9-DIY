<!-- 公共的 head 部分，可以定义部分 links,scripts,styles -->
<th:block th:fragment="head(htmlType)">
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width,initial-scale=1" name="viewport">
    <meta content="telephone=no" name="format-detection">
    <meta content="var(--heo-card-bg)" name="theme-color">
    <title th:text="${siteTitle}"></title>
    <link rel="shortcut icon"
          th:href="@{${#strings.isEmpty(site.favicon) ? assets_link + '/images/hao-logo.jpg' : site.favicon}}"/>
    <script src="/themes/theme-hao/assets/libs/jquery.min.js"></script>

    <script th:src="${assets_link + '/js/heo.js' + theme_version}"></script>

    <script th:src="${assets_link + '/js/halo.js' + theme_version}"></script>

    <link rel="stylesheet" th:href="${assets_link + '/libs/fancybox/jquery.fancybox.min.css'}">

    <link rel="stylesheet" th:href="${assets_link + '/zhheo/zhheoblog.css' + theme_version}">

    <link rel="stylesheet" th:href="${assets_link + '/zhheo/custom.css' + theme_version}">

    <link rel="stylesheet" th:href="${assets_link + '/zhheo/commentBarrage.css'}">

    <style th:if="${theme.config.other.scrollbarLinearGradientEnable}">
        *::-webkit-scrollbar-thumb {
            background-color: var(--heo-main);
            background-image: -webkit-linear-gradient(45deg,rgba(255,255,255,.4) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.4) 50%,rgba(255,255,255,.4) 75%,transparent 75%,transparent);
            border-radius: 2em
        }
    </style>

    <!-- swiper 在瞬间滚动时会使用 -->
    <link th:if="${theme.config.top.moment}" rel="stylesheet" href="/themes/theme-hao/assets/libs/swiper-bundle.min.css"/>

    <!-- 右下角通知 -->
    <link href="/themes/theme-hao/assets/libs/snackbar.min.css"
          media="print"
          onload='this.media="all"'
          rel="stylesheet"
    />

    <!-- 代码块自动识别语言 -->
    <th:block th:replace="~{modules/common/code}"/>
    <!--  代码块-->
    <th:block th:replace="~{macro/prism-code}"/>

    <!-- 页脚内容-样式一 -->
    <th:block th:replace="~{modules/common/footer-style-one}"/>

    <script>
        (win => {
            win.saveToLocal = {
                set: function setWithExpiry(key, value, ttl) {
                    if (ttl === 0) return
                    const now = new Date()
                    const expiryDay = ttl * 86400000
                    const item = {
                        value: value,
                        expiry: now.getTime() + expiryDay,
                    }
                    localStorage.setItem(key, JSON.stringify(item))
                },

                get: function getWithExpiry(key) {
                    const itemStr = localStorage.getItem(key)

                    if (!itemStr) {
                        return undefined
                    }
                    const item = JSON.parse(itemStr)
                    const now = new Date()

                    if (now.getTime() > item.expiry) {
                        localStorage.removeItem(key)
                        return undefined
                    }
                    return item.value
                }
            }

            win.getScript = url => new Promise((resolve, reject) => {
                const script = document.createElement('script')
                script.src = url
                script.async = true
                script.onerror = reject
                script.onload = script.onreadystatechange = function () {
                    const loadState = this.readyState
                    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
                    script.onload = script.onreadystatechange = null
                    resolve()
                }
                document.head.appendChild(script)
            })

            win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
                const link = document.createElement('link')
                link.rel = 'stylesheet'
                link.href = url
                if (id) link.id = id
                link.onerror = reject
                link.onload = link.onreadystatechange = function() {
                    const loadState = this.readyState
                    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
                    link.onload = link.onreadystatechange = null
                    resolve()
                }
                document.head.appendChild(link)
            })

            win.activateDarkMode = function () {
                document.documentElement.setAttribute('data-theme', 'dark')
                document.documentElement.classList.add('color-scheme-dark')
                heo.initThemeColor()
            }
            win.activateLightMode = function () {
                document.documentElement.setAttribute('data-theme', 'light')
                document.documentElement.classList.remove('color-scheme-dark')
                heo.initThemeColor()
            }
            const t = saveToLocal.get('theme')

            const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
            const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
            const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
            const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

            if (t === undefined) {
                if (isLightMode) activateLightMode()
                else if (isDarkMode) activateDarkMode()
                else if (isNotSpecified || hasNoSupport) {
                    const now = new Date()
                    const hour = now.getHours()
                    const isNight = hour <= 6 || hour >= 18
                    isNight ? activateDarkMode() : activateLightMode()
                }
                window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
                    if (saveToLocal.get('theme') === undefined) {
                        e.matches ? activateDarkMode() : activateLightMode()
                    }
                })
            } else if (t === 'light') activateLightMode()
            else activateDarkMode()

            if("[[${theme.config.style.colorScheme}]]" === 'dark')
                activateDarkMode()
            if("[[${theme.config.style.colorScheme}]]" === 'light')
                activateLightMode()

            const asideStatus = saveToLocal.get('aside-status')
            if (asideStatus !== undefined) {
                if (asideStatus === 'hide') {
                    document.documentElement.classList.add('hide-aside')
                } else {
                    document.documentElement.classList.remove('hide-aside')
                }
            }
        })(window)
    </script>

    <!-- 动态加载条 -->
    <script data-pace-options="{ &quot;restartOnRequestAfter&quot;: false, &quot;eventLag&quot;: false, &quot;restartOnPushState&quot;: false, &quot;startOnPageLoad&quot;: true, &quot;minTime&quot;: 0, &quot;ghostTime&quot;: 0 }"
            th:src="${assets_link + '/libs/pace/pace.min.js'}"
            th:if="${theme.config.other.loadingBoxs.loadProgressBar}">
    </script>

    <!-- 复制 https://githubfast.com/zenorocha/clipboard.js -->
    <script th:src="${assets_link + '/libs/clipboard/clipboard.min.js'}"></script>

    <!-- 关于统计-->
    <script th:if="${#strings.contains(theme.config.about.widgets,'statistics-map')}" th:src="${assets_link + '/libs/countup/countup.js'}"></script>

    <!-- 小板报 -->
    <th:block th:if="${not #strings.isEmpty(theme.config.sidebar.welcome.key)}">
        <script defer th:if="${#strings.contains(theme.config.sidebar.widgetss.indexWidgets,'welcome') ||
            #strings.contains(theme.config.sidebar.widgetss.postWidgets,'welcome') ||
            #strings.contains(theme.config.sidebar.widgetss.tagWidgets,'welcome') ||
            #strings.contains(theme.config.sidebar.widgetss.categoryWidgets,'welcome')}"
                th:src="${assets_link + '/libs/welcome/welcome.js'}"></script>
    </th:block>

    <!-- icon图标 -->
    <link rel="stylesheet" th:href="${assets_link + '/icon/iconfont.css' + theme_version}">
    
    <!-- icon图标--仍用后台的 //at.alicdn.com/... 地址，这里自动转 https 并固定 id -->
<script id="iconfont-symbol" defer
        th:src="${#strings.startsWith(theme.config.nav.menus.iconfont_js, '//') 
                  ? 'https:' + theme.config.nav.menus.iconfont_js 
                  : theme.config.nav.menus.iconfont_js}"></script>
<script>
  (function () {
    if (window.__ICONFONT_READY__) return;   // 防重复
    window.__ICONFONT_READY__ = true;

    function getSprite(){ return document.querySelector('[id^="__svg__icons__dom__"]'); }
    function persistSprite(){
      var spr = getSprite();
      if (spr && spr.parentNode !== document.body) document.body.appendChild(spr);
      return !!spr;
    }
    function ensureSprite(){
      if (persistSprite()) return;
      var src = document.getElementById('iconfont-symbol')?.getAttribute('src');
      if (!src) return;
      var s = document.createElement('script');
      s.defer = true; s.src = src;
      s.onload = persistSprite;
      document.head.appendChild(s);
    }

    document.addEventListener('DOMContentLoaded', ensureSprite);
    window.addEventListener('load', ensureSprite);
    document.addEventListener('pjax:complete', ensureSprite);
  })();
</script>

    <th:block th:replace="~{modules/variables/site-config :: site-config}" />


    <style id="diy-effects-guard">
  /* 画布/飘落/灯笼类容器：固定定位 + 不参与点击，避免撑高页面 */
  body > canvas,
  body > [id*="universe"], body > [class*="universe"],
  body > [id*="circle"],   body > [class*="circleMagic"],
  body > [id*="quantum"],  body > [class*="quantum"],
  body > [id*="sakura"],   body > [class*="sakura"],
  body > [id*="snow"],     body > [class*="snow"],
  body > [class*="lantern"], body > [id*="lantern"]{
    position: fixed !important;
    left: 0 !important; top: 0 !important;
    width: 100vw !important; height: 100vh !important;
    pointer-events: none !important;
    z-index: 1;
  }
  /* 灯笼自身不挡点击 */
  .lantern, .lantern * { pointer-events: none !important; }
</style>



    <!-- === Webfonts: 8 Chinese display fonts + system fallback (linked to global_font) === -->
    <link rel="preconnect" href="https://oortaka.top" crossorigin>
    <style id="webfonts-base">
      /* register 8 fonts (served from your domain) */
      @font-face{font-family:'zhankukuaile';  src:url('https://oortaka.top/ziti/zhankukuaile.woff2')  format('woff2'); font-weight:400; font-style:normal; font-display:swap;}
      @font-face{font-family:'zhankugdh';      src:url('https://oortaka.top/ziti/zhankugdh.woff2')      format('woff2'); font-weight:400; font-style:normal; font-display:swap;}
      @font-face{font-family:'zhankuyuyang';   src:url('https://oortaka.top/ziti/zhankuyuyang.woff2')   format('woff2'); font-weight:400; font-style:normal; font-display:swap;}
      @font-face{font-family:'zhankuheiti';    src:url('https://oortaka.top/ziti/zhankuheiti.woff2')    format('woff2'); font-weight:400; font-style:normal; font-display:swap;}
      @font-face{font-family:'zhankuwenyi';    src:url('https://oortaka.top/ziti/zhankuwenyi.woff2')    format('woff2'); font-weight:400; font-style:normal; font-display:swap;}
      @font-face{font-family:'zhankuhuangyou'; src:url('https://oortaka.top/ziti/zhankuhuangyou.woff2') format('woff2'); font-weight:400; font-style:normal; font-display:swap;}
      @font-face{font-family:'zhankuxiaowei';  src:url('https://oortaka.top/ziti/zhankuxiaowei.woff2')  format('woff2'); font-weight:400; font-style:normal; font-display:swap;}
      @font-face{font-family:'zhuziawan';      src:url('https://oortaka.top/ziti/zhuziawan.woff2')      format('woff2'); font-weight:400; font-style:normal; font-display:swap;}

      /* default when "关闭(off)" or unset: system font stack */
      :root{
        --site-font: -apple-system, BlinkMacSystemFont, "Segoe UI",
                     "PingFang SC", "Microsoft YaHei", "Noto Sans CJK SC",
                     "Helvetica Neue", Arial, sans-serif;
      }
      body{ font-family: var(--site-font); }
    </style>

    <!-- preload ONLY the selected font for faster paint -->
    <th:block th:switch="${theme.config.style.global_font}">
      <link th:case="'zhankukuaile'"   rel="preload" href="https://oortaka.top/ziti/zhankukuaile.woff2"  as="font" type="font/woff2" crossorigin>
      <link th:case="'zhankugdh'"      rel="preload" href="https://oortaka.top/ziti/zhankugdh.woff2"      as="font" type="font/woff2" crossorigin>
      <link th:case="'zhankuyuyang'"   rel="preload" href="https://oortaka.top/ziti/zhankuyuyang.woff2"   as="font" type="font/woff2" crossorigin>
      <link th:case="'zhankuheiti'"    rel="preload" href="https://oortaka.top/ziti/zhankuheiti.woff2"    as="font" type="font/woff2" crossorigin>
      <link th:case="'zhankuwenyi'"    rel="preload" href="https://oortaka.top/ziti/zhankuwenyi.woff2"    as="font" type="font/woff2" crossorigin>
      <link th:case="'zhankuhuangyou'" rel="preload" href="https://oortaka.top/ziti/zhankuhuangyou.woff2" as="font" type="font/woff2" crossorigin>
      <link th:case="'zhankuxiaowei'"  rel="preload" href="https://oortaka.top/ziti/zhankuxiaowei.woff2"  as="font" type="font/woff2" crossorigin>
      <link th:case="'zhuziawan'"      rel="preload" href="https://oortaka.top/ziti/zhuziawan.woff2"      as="font" type="font/woff2" crossorigin>
    </th:block>

    <!-- switch CSS variable to selected font (no need to touch <body>) -->
    <th:block th:switch="${theme.config.style.global_font}">
      <style th:case="'zhankukuaile'">  :root{ --site-font: 'zhankukuaile', 'PingFang SC','Microsoft YaHei',sans-serif; } </style>
      <style th:case="'zhankugdh'">     :root{ --site-font: 'zhankugdh',    'PingFang SC','Microsoft YaHei',sans-serif; } </style>
      <style th:case="'zhankuyuyang'">  :root{ --site-font: 'zhankuyuyang', 'PingFang SC','Microsoft YaHei',sans-serif; } </style>
      <style th:case="'zhankuheiti'">   :root{ --site-font: 'zhankuheiti',  'PingFang SC','Microsoft YaHei',sans-serif; } </style>
      <style th:case="'zhankuwenyi'">   :root{ --site-font: 'zhankuwenyi',  'PingFang SC','Microsoft YaHei',sans-serif; } </style>
      <style th:case="'zhankuhuangyou'">:root{ --site-font: 'zhankuhuangyou','PingFang SC','Microsoft YaHei',sans-serif; } </style>
      <style th:case="'zhankuxiaowei'"> :root{ --site-font: 'zhankuxiaowei','PingFang SC','Microsoft YaHei',sans-serif; } </style>
      <style th:case="'zhuziawan'">     :root{ --site-font: 'zhuziawan',    'PingFang SC','Microsoft YaHei',sans-serif; } </style>
      <!-- off/unset: keep system stack -->
    </th:block>

</th:block>

<style id="webfonts-force-all">
/* 强制所有元素（含伪元素）使用 --site-font；再覆盖常见表单/ SVG 文本 */
*, *::before, *::after { font-family: var(--site-font) !important; }
svg, svg *, svg text, svg tspan { font-family: var(--site-font) !important; }
</style>
<script>
// 保证样式总是位于 <head> 最后，PJAX/局部刷新后也继续生效
(function(){ 
  var css = '\n/* 强制所有元素（含伪元素）使用 --site-font；再覆盖常见表单/ SVG 文本 */\n*, *::before, *::after { font-family: var(--site-font) !important; }\nsvg, svg *, svg text, svg tspan { font-family: var(--site-font) !important; }\n';
  function apply(){ 
    var el = document.getElementById('webfonts-force-all');
    if(!el){ el = document.createElement('style'); el.id='webfonts-force-all'; document.head.appendChild(el); }
    el.textContent = css;
    document.head.appendChild(el); // 追加到最后，提升优先级
  }
  apply();
  document.addEventListener('DOMContentLoaded', apply);
  window.addEventListener('load', apply);
  // 常见 PJAX 事件
  document.addEventListener('pjax:complete', apply);
  document.addEventListener('pjax:success', apply);
  document.addEventListener('page:loaded', apply);
  // 有些主题晚注入 CSS，这里再补几次
  setTimeout(apply, 0);
  setTimeout(apply, 300);
  setTimeout(apply, 800);
})();
</script>

