<!-- 公共的 head 部分，可以定义部分 links,scripts,styles -->
<th:block th:fragment="head(htmlType)">
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width,initial-scale=1" name="viewport">
    <meta content="telephone=no" name="format-detection">
    <meta content="var(--heo-card-bg)" name="theme-color">
    <title th:text="${siteTitle}"></title>
    <link rel="shortcut icon"
          th:href="@{${#strings.isEmpty(site.favicon) ? assets_link + '/images/hao-logo.jpg' : site.favicon}}"/>
    <script src="/themes/theme-hao/assets/libs/jquery.min.js"></script>

    <!-- ===== PJAX 开关：只改回退问题 ===== -->
    <script th:if="${theme.config.other.pjax_enable}" src="/themes/theme-hao/assets/libs/pjax/pjax.min.js"></script>

    <script th:if="${theme.config.other.pjax_enable}">
      (function(){
        if (window.__PJAX_INITED) return;
        window.__PJAX_INITED = true;
        if (!window.Pjax) return;
        try {
          new Pjax({
            elements: 'a[href]:not([target="_blank"]):not([data-pjax="ignore"])',
            selectors: ['title', '#content', '#post', '#page', '#rightside'],
            cache: true,
            history: true,
            scrollTo: false
          });
          console.log('[PJAX] enabled (scrollTo:false)');
        } catch(e) { console.warn('PJAX init failed:', e); }
      })();
    </script>

    <!-- Back Button Fix: robust restore + pagination guard -->
    <script th:if="${theme.config.other.pjax_enable}">
    (function(){
      if (window.__BACK_FIX__) return; window.__BACK_FIX__ = true;

      // --- flags ---
      window.__IS_BACK_NAV__ = false;
      const PAGINATE_KEY = '__PAGINATE_CLICKED__';

      // mark back/forward
      document.addEventListener('pjax:popstate', function(){ window.__IS_BACK_NAV__ = true; });
      window.addEventListener('pageshow', function(e){
        try {
          var nav = performance.getEntriesByType && performance.getEntriesByType('navigation')[0];
          if (e.persisted || (nav && nav.type === 'back_forward')) window.__IS_BACK_NAV__ = true;
        } catch(_){}
      });

      // save scroll
      const key = function(){ return '__SCROLL__' + encodeURIComponent(location.pathname + location.search + location.hash); };
      const save = function(){
        try { sessionStorage.setItem(key(), String(window.scrollY || 0)); } catch(e){}
      };
      const read = function(){
        try { var y = parseInt(sessionStorage.getItem(key()) || '0', 10); return isNaN(y)?0:y; } catch(e){ return 0; }
      };

      document.addEventListener('pjax:send', save, {capture:true});
      window.addEventListener('pagehide', save, {capture:true});

      // mark paginate clicks, so your auto-scroll只在“主动翻页”时执行
      document.addEventListener('click', function(ev){
        var a = ev.target && ev.target.closest ? ev.target.closest('a') : null;
        if (!a) return;
        // 常见分页选择器：按你的主题改了也不影响，尽量覆盖
        if (a.matches('.pagination a, a.page-numbers, a[rel="next"], a[rel="prev"], .pager a, .nav-links a')) {
          try { sessionStorage.setItem(PAGINATE_KEY, '1'); } catch(e){}
        }
      }, true);

      // 暴露一个供你现有“分页自动下滑”判断的函数（如果你愿意用它包一层就更稳）
      window.__shouldAutoScrollAfterPagination__ = function(){
        var clicked = sessionStorage.getItem(PAGINATE_KEY) === '1';
        var isBack = window.__IS_BACK_NAV__ === true;
        // 用过即焚，避免多次触发
        try { sessionStorage.removeItem(PAGINATE_KEY); } catch(e){}
        return clicked && !isBack;
      };

      function robustRestore(){
        if (!window.__IS_BACK_NAV__) return;
        var targetY = read();
        if (!(targetY > 0)) return;

        var tries = 0, maxTries = 40, done = false, lastH = 0, start = Date.now();
        var container = document.querySelector('#content,#post,#page,#body-wrap') || document.body;
        var goodEnough = function(){ return Math.abs((window.scrollY||0) - targetY) <= 2; };

        function tick(){
          if (done) return;
          tries++;
          window.scrollTo(0, targetY);
          var h = (container && container.scrollHeight) || document.documentElement.scrollHeight || document.body.scrollHeight;
          var grown = h > lastH; lastH = h;
          if (goodEnough()) { done = true; return; }
          if (tries < maxTries) {
            var elapsed = Date.now() - start;
            if (elapsed > 3000) return;
            var delay = tries<10 ? 0 : tries<18 ? 50 : tries<28 ? 120 : 240;
            (delay ? setTimeout(tick, delay) : requestAnimationFrame(tick));
          }
        }
        requestAnimationFrame(tick);

        try{
          var imgs = Array.prototype.slice.call(document.images||[]).filter(function(i){ return i && !i.complete; });
          if (imgs.length){
            var left = imgs.length, fired = false;
            function again(){ if(!fired){ fired = true; requestAnimationFrame(tick);} }
            imgs.forEach(function(img){
              img.addEventListener('load', function(){ if(--left===0) again(); }, {once:true});
              img.addEventListener('error', function(){ if(--left===0) again(); }, {once:true});
            });
            setTimeout(again, 800);
          }
        }catch(e){}
      }

      // 恢复时机：后退/前进、bfcache、以及 pjax 完成后兜底
      document.addEventListener('pjax:complete', function(){
        robustRestore();
        if (window.__IS_BACK_NAV__) {
          setTimeout(robustRestore, 60);
          setTimeout(robustRestore, 180);
          setTimeout(robustRestore, 400);
          // 一段时间后把标志清掉，回到正常模式
          setTimeout(function(){ window.__IS_BACK_NAV__ = false; }, 800);
        }
      });
      document.addEventListener('pjax:popstate', robustRestore);
      window.addEventListener('pageshow', robustRestore);
    })();
    </script>
    <!-- ===== end back-fix ===== -->

    <script th:src="${assets_link + '/js/heo.js' + theme_version}"></script>

    <script th:src="${assets_link + '/js/halo.js' + theme_version}"></script>

    <link rel="stylesheet" th:href="${assets_link + '/libs/fancybox/jquery.fancybox.min.css'}">

    <link rel="stylesheet" th:href="${assets_link + '/zhheo/zhheoblog.css' + theme_version}">

    <link rel="stylesheet" th:href="${assets_link + '/zhheo/custom.css' + theme_version}">

    <link rel="stylesheet" th:href="${assets_link + '/zhheo/commentBarrage.css'}">

    <style th:if="${theme.config.other.scrollbarLinearGradientEnable}">
        *::-webkit-scrollbar-thumb {
            background-color: var(--heo-main);
            background-image: -webkit-linear-gradient(45deg,rgba(255,255,255,.4) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.4) 50%,rgba(255,255,255,.4) 75%,transparent 75%,transparent);
            border-radius: 2em
        }
    </style>

    <!-- swiper 在瞬间滚动时会使用 -->
    <link th:if="${theme.config.top.moment}" rel="stylesheet" href="/themes/theme-hao/assets/libs/swiper-bundle.min.css"/>

    <!-- 右下角通知 -->
    <link href="/themes/theme-hao/assets/libs/snackbar.min.css"
          media="print"
          onload='this.media="all"'
          rel="stylesheet"
    />

    <!-- 代码块自动识别语言 -->
    <th:block th:replace="~{modules/common/code}"/>
    <!--  代码块-->
    <th:block th:replace="~{macro/prism-code}"/>

    <!-- 页脚内容-样式一 -->
    <th:block th:replace="~{modules/common/footer-style-one}"/>

    <script>
        (win => {
            win.saveToLocal = {
                set: function setWithExpiry(key, value, ttl) {
                    if (ttl === 0) return
                    const now = new Date()
                    const expiryDay = ttl * 86400000
                    const item = {
                        value: value,
                        expiry: now.getTime() + expiryDay,
                    }
                    localStorage.setItem(key, JSON.stringify(item))
                },

                get: function getWithExpiry(key) {
                    const itemStr = localStorage.getItem(key)

                    if (!itemStr) {
                        return undefined
                    }
                    const item = JSON.parse(itemStr)
                    const now = new Date()

                    if (now.getTime() > item.expiry) {
                        localStorage.removeItem(key)
                        return undefined
                    }
                    return item.value
                }
            }

            win.getScript = url => new Promise((resolve, reject) => {
                const script = document.createElement('script')
                script.src = url
                script.async = true
                script.onerror = reject
                script.onload = script.onreadystatechange = function () {
                    const loadState = this.readyState
                    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
                    script.onload = script.onreadystatechange = null
                    resolve()
                }
                document.head.appendChild(script)
            })

            win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
                const link = document.createElement('link')
                link.rel = 'stylesheet'
                link.href = url
                if (id) link.id = id
                link.onerror = reject
                link.onload = link.onreadystatechange = function() {
                    const loadState = this.readyState
                    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
                    link.onload = link.onreadystatechange = null
                    resolve()
                }
                document.head.appendChild(link)
            })

            win.activateDarkMode = function () {
                document.documentElement.setAttribute('data-theme', 'dark')
                document.documentElement.classList.add('color-scheme-dark')
                heo.initThemeColor()
            }
            win.activateLightMode = function () {
                document.documentElement.setAttribute('data-theme', 'light')
                document.documentElement.classList.remove('color-scheme-dark')
                heo.initThemeColor()
            }
            const t = saveToLocal.get('theme')

            const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
            const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
            const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
            const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

            if (t === undefined) {
                if (isLightMode) activateLightMode()
                else if (isDarkMode) activateDarkMode()
                else if (isNotSpecified || hasNoSupport) {
                    const now = new Date()
                    const hour = now.getHours()
                    const isNight = hour <= 6 || hour >= 18
                    isNight ? activateDarkMode() : activateLightMode()
                }
                window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
                    if (saveToLocal.get('theme') === undefined) {
                        e.matches ? activateDarkMode() : activateLightMode()
                    }
                })
            } else if (t === 'light') activateLightMode()
            else activateDarkMode()

            if("[[${theme.config.style.colorScheme}]]" === 'dark')
                activateDarkMode()
            if("[[${theme.config.style.colorScheme}]]" === 'light')
                activateLightMode()

            const asideStatus = saveToLocal.get('aside-status')
            if (asideStatus !== undefined) {
                if (asideStatus === 'hide') {
                    document.documentElement.classList.add('hide-aside')
                } else {
                    document.documentElement.classList.remove('hide-aside')
                }
            }
        })(window)
    </script>

    <!-- 动态加载条 -->
    <script data-pace-options="{ &quot;restartOnRequestAfter&quot;: false, &quot;eventLag&quot;: false, &quot;restartOnPushState&quot;: false, &quot;startOnPageLoad&quot;: true, &quot;minTime&quot;: 0, &quot;ghostTime&quot;: 0 }"
            th:src="${assets_link + '/libs/pace/pace.min.js'}"
            th:if="${theme.config.other.loadingBoxs.loadProgressBar}">
    </script>

    <!-- 复制 https://githubfast.com/zenorocha/clipboard.js -->
    <script th:src="${assets_link + '/libs/clipboard/clipboard.min.js'}"></script>

    <!-- 关于统计-->
    <script th:if="${#strings.contains(theme.config.about.widgets,'statistics-map')}" th:src="${assets_link + '/libs/countup/countup.js'}"></script>

    <!-- 小板报 -->
    <th:block th:if="${not #strings.isEmpty(theme.config.sidebar.welcome.key)}">
        <script defer th:if="${#strings.contains(theme.config.sidebar.widgetss.indexWidgets,'welcome') ||
            #strings.contains(theme.config.sidebar.widgetss.postWidgets,'welcome') ||
            #strings.contains(theme.config.sidebar.widgetss.tagWidgets,'welcome') ||
            #strings.contains(theme.config.sidebar.widgetss.categoryWidgets,'welcome')}"
                th:src="${assets_link + '/libs/welcome/welcome.js'}"></script>
    </th:block>

    <!-- icon图标 -->
    <link rel="stylesheet" th:href="'https://cdn.cbd.int/hao-theme-static@'+${theme.spec.version}+'/icon/iconfont.css'">

    <th:block th:replace="~{modules/variables/site-config :: site-config}" />


</th:block>
