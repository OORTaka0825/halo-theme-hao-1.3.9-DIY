<!-- 公共的 head 部分，可以定义部分 links,scripts,styles -->
<th:block th:fragment="head(htmlType)">
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width,initial-scale=1" name="viewport">
    <meta content="telephone=no" name="format-detection">
    <meta content="var(--heo-card-bg)" name="theme-color">
    <title th:text="${siteTitle}"></title>
    <link rel="shortcut icon"
          th:href="@{${#strings.isEmpty(site.favicon) ? assets_link + '/images/hao-logo.jpg' : site.favicon}}"/>

    <script th:src="${assets_link + '/libs/jquery/jquery.min.js'}"></script>

    <!-- ===== PJAX：参考原主题初始化（重要） ===== -->
    <script th:if="${theme.config.other.pjax_enable}" th:src="${assets_link + '/libs/pjax/pjax.min.js'}"></script>
    <script th:if="${theme.config.other.pjax_enable}">
      (function () {
        if (window.__PJAX_INITED) return;
        window.__PJAX_INITED = true;
        if (!window.Pjax) return;

        // 让浏览器别自己恢复滚动，交给 PJAX/我们自己
        try { history.scrollRestoration = "manual"; } catch (e) {}

        // 参考原主题的选择器：尽量覆盖主内容、右侧、配置片段、以及需要通过 PJAX 更新的块
        var pjaxSelectors = [
          'title', '#config-diff', '#body-wrap',
          '#rightside', '#rightside-config-hide', '#rightside-config-show',
          '.js-pjax', '#site-config',
          // 兼容你当前主题结构
          '#content', '#post', '#page'
        ];

        // 同步更新 meta（社交卡片）
        pjaxSelectors.unshift(
          'meta[property="og:type"]','meta[property="og:title"]','meta[property="og:url"]','meta[property="og:description"]',
          'meta[name="twitter:title"]','meta[name="twitter:card"]','meta[name="twitter:description"]','meta[name="twitter:image"]'
        );

        // 统一记录滚动（轻量兜底；PJAX 自身也会处理 scroll）
        function saveScroll() {
          try {
            var s = (history.state && typeof history.state === 'object') ? history.state : {};
            var next = Object.assign({}, s, { __scroll: window.scrollY || 0 });
            history.replaceState(next, '', location.href);
          } catch (e) {}
        }

        // 初始化 PJAX（对齐原主题配置）
        var pjax = new Pjax({
          elements: 'a:not([target="_blank"]):not([data-pjax="ignore"])',
          selectors: pjaxSelectors,
          cacheBust: false,
          analytics: false,
          scrollRestoration: false
        });

        // 发送前保存滚动
        document.addEventListener('pjax:send', saveScroll, { capture: true });

        // 完成后：按原主题流程刷新功能，并兜底恢复滚动
        document.addEventListener('pjax:complete', function (e) {
          // 原主题会调用 window.refreshFn(); 你的 heo.js 也会在 pjax:complete 做 initBlog()
          if (typeof window.refreshFn === 'function') window.refreshFn();
          if (typeof window.initBlog === 'function') window.initBlog();

          // 兜底恢复滚动（如 PJAX 未恢复或发生了重渲染）
          try {
            var st = (e && e.state) || history.state || {};
            var y = (typeof st.__scroll === 'number') ? st.__scroll : 0;
            if (y > 0) {
              setTimeout(function(){ window.scrollTo(0, y); }, 0);
            }
          } catch (err) {}
        });

        // 后退/前进时再兜底一次
        document.addEventListener('pjax:popstate', function (e) {
          try {
            var st = (e && e.state) || history.state || {};
            var y = (typeof st.__scroll === 'number') ? st.__scroll : 0;
            if (y > 0) {
              setTimeout(function(){ window.scrollTo(0, y); }, 0);
            }
          } catch (err) {}
        });

        // bfcache 还原时也兜底一次
        window.addEventListener('pageshow', function (e) {
          var persisted = !!(e && e.persisted);
          var isBF = false;
          try {
            var nav = performance.getEntriesByType && performance.getEntriesByType('navigation')[0];
            isBF = !!nav && nav.type === 'back_forward';
          } catch (err) {}
          if (persisted || isBF) {
            var st = history.state || {};
            if (typeof st.__scroll === 'number' && st.__scroll > 0) {
              setTimeout(function(){ window.scrollTo(0, st.__scroll); }, 0);
            }
          }
        });

        console.log('[PJAX] init from original theme, with scrollRestoration:false + broad selectors.');
      })();
    </script>
    <!-- ===== /PJAX ===== -->

    <script th:src="${assets_link + '/js/heo.js' + theme_version}"></script>
    <link rel="stylesheet" th:href="${assets_link + '/libs/fancybox/jquery.fancybox.min.css'}">
    <link rel="stylesheet" th:href="${assets_link + '/zhheo/zhheoblog.css' + theme_version}">
    <link rel="stylesheet" th:href="${assets_link + '/zhheo/custom.css' + theme_version}">
    <link rel="stylesheet" th:href="${assets_link + '/zhheo/commentBarrage.css'}">

    <style th:if="${theme.config.other.scrollbarLinearGradientEnable}">
        *::-webkit-scrollbar-thumb { background-color: var(--heo-main);
            background-image: -webkit-linear-gradient(45deg,rgba(255,255,255,.4) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.4) 50%,rgba(255,255,255,.4) 75%,transparent 75%,transparent);
            border-radius: 2em }
    </style>

    <!-- swiper 在瞬间滚动时会使用 -->
    <link th:if="${theme.config.top.moment}" rel="stylesheet" th:href="${assets_link + '/libs/swiper/swiper-bundle.min.css'}"/>

    <!-- 右下角通知 -->
    <link th:href="${assets_link + '/libs/node-snackbar/snackbar.min.css'}" media="print" onload='this.media="all"' rel="stylesheet" />

    <!-- 代码块自动识别语言 -->
    <th:block th:replace="~{modules/common/code}"/>
    <!--  代码块-->
    <th:block th:replace="~{macro/prism-code}"/>

    <!-- 页脚内容-样式一 -->
    <th:block th:replace="~{modules/common/footer-style-one}"/>

    <script>
      (win => {
        win.saveToLocal = {
          set: function setWithExpiry(key, value, ttl) {
            if (ttl === 0) return
            const now = new Date()
            const expiryDay = ttl * 86400000
            const item = { value: value, expiry: now.getTime() + expiryDay }
            localStorage.setItem(key, JSON.stringify(item))
          },
          get: function getWithExpiry(key) {
            const itemStr = localStorage.getItem(key)
            if (!itemStr) return undefined
            const item = JSON.parse(itemStr)
            const now = new Date()
            if (now.getTime() > item.expiry) {
              localStorage.removeItem(key)
              return undefined
            }
            return item.value
          }
        }
        win.getScript = url => new Promise((resolve, reject) => {
          const script = document.createElement('script')
          script.src = url; script.async = true
          script.onerror = reject
          script.onload = script.onreadystatechange = function () {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            script.onload = script.onreadystatechange = null
            resolve()
          }
          document.head.appendChild(script)
        })
        win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
          const link = document.createElement('link')
          link.rel = 'stylesheet'; link.href = url; if (id) link.id = id
          link.onerror = reject
          link.onload = link.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            link.onload = link.onreadystatechange = null
            resolve()
          }
          document.head.appendChild(link)
        })
        win.activateDarkMode = function () {
          document.documentElement.setAttribute('data-theme', 'dark')
          document.documentElement.classList.add('color-scheme-dark')
          heo.initThemeColor()
        }
        win.activateLightMode = function () {
          document.documentElement.setAttribute('data-theme', 'light')
          document.documentElement.classList.remove('color-scheme-dark')
          heo.initThemeColor()
        }
        const t = saveToLocal.get('theme')
        const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
        const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
        const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
        const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
        if (t === undefined) {
          if (isLightMode) activateLightMode()
          else if (isDarkMode) activateDarkMode()
          else if (isNotSpecified || hasNoSupport) {
            const now = new Date(); const hour = now.getHours()
            const isNight = hour <= 6 || hour >= 18
            isNight ? activateDarkMode() : activateLightMode()
          }
          window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
            if (saveToLocal.get('theme') === undefined) { e.matches ? activateDarkMode() : activateLightMode() }
          })
        } else if (t === 'light') activateLightMode()
        else activateDarkMode()
        if("[[${theme.config.style.colorScheme}]]" === 'dark') activateDarkMode()
        if("[[${theme.config.style.colorScheme}]]" === 'light') activateLightMode()
        const asideStatus = saveToLocal.get('aside-status')
        if (asideStatus !== undefined) {
          if (asideStatus === 'hide') { document.documentElement.classList.add('hide-aside') }
          else { document.documentElement.classList.remove('hide-aside') }
        }
      })(window)
    </script>

    <!-- 动态加载条 -->
    <script data-pace-options="{ &quot;restartOnRequestAfter&quot;: false, &quot;eventLag&quot;: false, &quot;restartOnPushState&quot;: false, &quot;startOnPageLoad&quot;: true, &quot;minTime&quot;: 0, &quot;ghostTime&quot;: 0 }"
            th:src="${assets_link + '/libs/pace/pace.min.js'}"
            th:if="${theme.config.other.loadingBoxs.loadProgressBar}"></script>

    <!-- 复制 https://githubfast.com/zenorocha/clipboard.js -->
    <script th:src="${assets_link + '/libs/clipboard/clipboard.min.js'}"></script>

    <!-- 关于统计-->
    <script th:if="${#strings.contains(theme.config.about.widgets,'statistics-map')}" th:src="${assets_link + '/libs/countup/countup.js'}"></script>

    <!-- 小板报 -->
    <th:block th:if="${not #strings.isEmpty(theme.config.sidebar.welcome.key)}">
        <script defer th:if="${#strings.contains(theme.config.sidebar.widgetss.indexWidgets,'welcome') ||
            #strings.contains(theme.config.sidebar.widgetss.postWidgets,'welcome') ||
            #strings.contains(theme.config.sidebar.widgetss.tagWidgets,'welcome') ||
            #strings.contains(theme.config.sidebar.widgetss.categoryWidgets,'welcome')}"
                th:src="${assets_link + '/libs/welcome/welcome.js'}"></script>
    </th:block>

    <!-- icon图标 -->
    <link rel="stylesheet" th:href="'https://cdn.cbd.int/hao-theme-static@'+${theme.spec.version}+'/icon/iconfont.css'">

    <th:block th:replace="~{modules/variables/site-config :: site-config}" />
</th:block>
