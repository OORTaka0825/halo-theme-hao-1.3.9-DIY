<!-- 无 PJAX 进度条“单段模式”事件桥：不新增进度条，只让主题自带的那一条在新页面统一起跑 -->
<th:block>
  <script>
  (function () {
    if (window.__hao_pjax_event_bridge__) return;
    window.__hao_pjax_event_bridge__ = true;

    var USE_PJAX = !!(window.pjax && typeof window.pjax.loadUrl === 'function');
    if (USE_PJAX) return; // 开启 PJAX 时完全让路

    var KEY = 'hao:pjax-bridge';

    function isSelfNav(e){
      if (e.defaultPrevented || e.button!==0) return false;
      if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return false;
      var a = e.target.closest && e.target.closest('a');
      if (!a) return false;
      var href = a.getAttribute('href') || '';
      if (!href || href.startsWith('#')) return false;
      if (a.target && a.target !== '_self') return false;
      try { var u = new URL(a.href, location.href); if (u.origin !== location.origin) return false; } catch(e){ return false; }
      return true;
    }

    // 离开旧页时：只记录标记，不触发任何进度事件（避免第一段）
    document.addEventListener('click', function(e){
      if (!isSelfNav(e)) return;
      try { sessionStorage.setItem(KEY, '1'); } catch(e) {}
    }, true);
    document.addEventListener('submit', function(){
      try { sessionStorage.setItem(KEY, '1'); } catch(e) {}
    }, true);

    // 新页面：统一在这里起跑 & 收尾 —— 只显示“一段”
    if (sessionStorage.getItem(KEY)) {
      try { sessionStorage.removeItem(KEY); } catch(e) {}

      function fire(name){ try { document.dispatchEvent(new Event(name)); } catch(e) {} }

      // 尽早启动：等待最短时间与 DOM 可用（防止监听还未挂载）
      var started = false;
      var startOnce = function(){ if (started) return; started = true; fire('pjax:send'); };

      if (document.readyState === 'loading') {
        // DOM 还在解析，安排一个宏任务 + DOMContentLoaded 双保险
        setTimeout(startOnce, 0);
        document.addEventListener('DOMContentLoaded', startOnce, { once: true });
      } else {
        // DOM 已可用，立即/下一个tick 开始
        setTimeout(startOnce, 0);
      }

      // 完成：在 load / pageshow 时结束，与 PJAX 行为对齐
      var finish = function(){
        fire('pjax:success');
        fire('pjax:complete');
        fire('page:loaded');
      };
      if (document.readyState === 'complete') {
        setTimeout(finish, 0);
      } else {
        window.addEventListener('load', finish, { once: true });
        window.addEventListener('pageshow', finish, { once: true });
      }
    }
  })();
  </script>
</th:block>
