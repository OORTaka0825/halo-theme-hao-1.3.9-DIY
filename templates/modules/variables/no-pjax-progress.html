<!-- 无 PJAX 时的进度条事件桥：不新增任何条，只触发主题现有进度条的事件 -->
<th:block>
  <script>
  (function () {
    if (window.__hao_pjax_event_bridge__) return;
    window.__hao_pjax_event_bridge__ = true;

    // 如果真的在用 PJAX，就不干预
    var USE_PJAX = !!(window.pjax && typeof window.pjax.loadUrl === 'function');
    if (USE_PJAX) return;

    var KEY = 'hao:pjax-bridge';

    function isSelfNav(e){
      if (e.defaultPrevented || e.button!==0) return false;
      if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return false;
      var a = e.target.closest && e.target.closest('a');
      if (!a) return false;
      var href = a.getAttribute('href') || '';
      if (!href || href.startsWith('#')) return false;
      if (a.target && a.target !== '_self') return false;
      try {
        var u = new URL(a.href, location.href);
        if (u.origin !== location.origin) return false; // 仅内部链接
      } catch(e){ return false; }
      return true;
    }

    function fire(name){
      try { document.dispatchEvent(new Event(name)); } catch(e) {}
    }

    // 点击离开当前页前：模拟 pjax:send（主题已有监听就能立刻显示原有进度条）
    document.addEventListener('click', function(e){
      if (!isSelfNav(e)) return;
      try { sessionStorage.setItem(KEY, '1'); } catch(e){}
      fire('pjax:send');
    }, true);

    // 表单提交也触发一遍
    document.addEventListener('submit', function(){
      try { sessionStorage.setItem(KEY, '1'); } catch(e){}
      fire('pjax:send');
    }, true);

    // 新页面：结束进度，和 PJAX 行为对齐
    if (sessionStorage.getItem(KEY)) {
      try { sessionStorage.removeItem(KEY); } catch(e){}
      var finish = function(){
        fire('pjax:success');   // 有些逻辑在 success 上收尾
        fire('pjax:complete');  // 大多数进度条在 complete 上结束
        fire('page:loaded');    // 你主题里常用的补充事件
      };
      if (document.readyState === 'complete') {
        setTimeout(finish, 0);
      } else {
        window.addEventListener('load', finish, { once: true });
      }
    }
  })();
  </script>
</th:block>
