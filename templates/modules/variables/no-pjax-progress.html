<!-- 关闭 PJAX 时的跨页顺滑进度条（安全版）：取消遮罩层，保留顶部细条 -->
<th:block>
  <script>
  (function () {
    var KEY = 'hao:progress:carry';
    var RUN = window.__hao_no_pjax_progress__;
    if (RUN) return; window.__hao_no_pjax_progress__ = true;

    var USE_PJAX = !!(window.pjax && typeof window.pjax.loadUrl === 'function');

    function pickColor() {
      try {
        var cs = getComputedStyle(document.documentElement);
        var c = (cs.getPropertyValue('--hao-post-hero-bg') ||
                 cs.getPropertyValue('--heo-theme') ||
                 cs.getPropertyValue('--heo-main') || '#7c5cff').trim();
        return c || '#7c5cff';
      } catch(e){ return '#7c5cff'; }
    }

    function ensureBar() {
      var bar = document.getElementById('hao-top-progress');
      if (bar) return bar;

      // 样式（无遮罩，只保留 2px 顶部条）
      var style = document.getElementById('hao-top-progress-style');
      if (!style) {
        style = document.createElement('style');
        style.id = 'hao-top-progress-style';
        style.textContent =
          '#hao-top-progress{position:fixed;top:0;left:0;right:0;height:2px;z-index:2147483647;pointer-events:none;opacity:0;transition:opacity .12s linear}'
        + '#hao-top-progress .hbar{position:absolute;left:0;top:0;height:2px;width:0;background:var(--hao-progress-color,#7c5cff);box-shadow:0 0 6px var(--hao-progress-color,#7c5cff);transition:width .28s ease}'
        + 'html.hao-loading #hao-top-progress{opacity:1}';
        document.head.appendChild(style);
      }
      bar = document.createElement('div');
      bar.id = 'hao-top-progress';
      bar.innerHTML = '<div class="hbar"></div>';
      bar.style.setProperty('--hao-progress-color', pickColor());
      document.body.appendChild(bar);
      return bar;
    }

    function start() {
      var el = ensureBar();
      document.documentElement.classList.add('hao-loading');
      requestAnimationFrame(function(){ el.querySelector('.hbar').style.width = '75%'; });
    }

    function done() {
      var el = document.getElementById('hao-top-progress');
      if (!el) return;
      el.querySelector('.hbar').style.width = '100%';
      setTimeout(function(){
        document.documentElement.classList.remove('hao-loading');
        el.querySelector('.hbar').style.width = '0';
      }, 150);
    }

    // 新页面接力
    if (sessionStorage.getItem(KEY) && !USE_PJAX) {
      start();
      var finished = false;
      var finish = function(){ if(finished) return; finished=true; done(); try{sessionStorage.removeItem(KEY);}catch(e){} };
      window.addEventListener('load', finish, { once:true });
      window.addEventListener('pageshow', finish, { once:true });
      document.addEventListener('visibilitychange', function(){ if(document.visibilityState==='visible') finish(); }, { once:true });
      setTimeout(finish, 7000);
    }

    function isSelfNav(e){
      if (USE_PJAX) return false;
      if (e.defaultPrevented || e.button!==0) return false;
      if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return false;
      var a = e.target.closest && e.target.closest('a');
      if (!a) return false;
      var href = a.getAttribute('href')||'';
      if (!href || href.startsWith('#')) return false;
      if (a.target && a.target !== '_self') return false;
      try{ var u = new URL(a.href, location.href); if(u.origin!==location.origin) return false; }catch(e){ return false; }
      return true;
    }

    document.addEventListener('click', function(e){
      if (!isSelfNav(e)) return;
      try { sessionStorage.setItem(KEY,'1'); } catch(e){}
      start();
    }, true);

    document.addEventListener('submit', function(){
      if (USE_PJAX) return;
      try { sessionStorage.setItem(KEY,'1'); } catch(e){}
      start();
    }, true);
  })();
  </script>
</th:block>
