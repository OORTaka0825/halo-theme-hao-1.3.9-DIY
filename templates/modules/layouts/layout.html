<!DOCTYPE html>
<html lang="en" th:fragment="layout(content, htmlType, title)" xmlns:th="http://www.thymeleaf.org"
      th:with="assets_link=${theme.config.other.staticResource.use == 'onmicrosoft' ? 'https://npm.onmicrosoft.cn/hao-theme-static@' + theme.spec.version +'/templates/assets' :
      theme.config.other.staticResource.use == 'cbd' ? 'https://cdn.cbd.int/hao-theme-static@' + theme.spec.version +'/templates/assets' :
      theme.config.other.staticResource.use == 'custom' ? theme.config.other.staticResource.cdn_link : #theme.assets('/')},
      theme_version = ${ theme.config.other.staticResource.use == 'local' ? '?v='+ theme.spec.version : ''},
      isLazyload = ${theme.config.other.vanillaLazyload.enable},
      loadingImg = ${theme.config.other.vanillaLazyload.loadingImg},
      siteTitle = ${not #strings.isEmpty(title) ?  title  :  #strings.isEmpty(site.subtitle) ? site.title :  site.title +' - ' +site.subtitle }">

<!-- head ä¸­è‡ªå®šä¹‰çš„  -->

<head>
    <th:block th:replace="~{modules/head :: head(htmlType = ${htmlType})}"/>
    <link th:if="${#strings.equals(theme.config.comments.use, 'Waline')
    && not #strings.isEmpty(theme.config.comments.walines.serverURL)}"
          rel="stylesheet"
          th:href="${not #strings.isEmpty(theme.config.comments.walines.walinesCss) ? theme.config.comments.walines.walinesCss : 'https://cdn.cbd.int/@waline/client@2.15.7/dist/waline.css' }">
    <!--  è§£å†³ katex pjaxé—®é¢˜ -->
    <script th:if="${pluginFinder.available('plugin-katex')}" defer=""
            src="/plugins/plugin-katex/assets/static/katex.min.js"></script>
    <script th:src="${assets_link + '/js/custom.js' + theme_version}"></script>
    <th:block th:if="${head != null}">
        <th:block th:replace="${head}"/>
    </th:block>

</head>

<body>

    <!-- loading é¡µé¢ -->
    <th:block th:replace="~{modules/loading-box}"/>
    
    <!-- ç½‘ç«™èƒŒæ™¯ -->
    <div id="web_bg">
        <div th:if="${theme.config.top.global_background.enable_global_background_img}">
            <img th:if="${theme.config.top.global_background.enable_global_background_above_video == false}"
                 class="global_background_img"
                 th:src="${theme.config.top.global_background.global_background_img}"
            />
            <video th:if="${theme.config.top.global_background.enable_global_background_above_video}"
                   class="index-video"
                   id="index-video"
                   autoplay=""
                   th:src="${theme.config.top.global_background.global_background_video}"
                   loop=""
                   muted=""
                   playsinline=""
                   webkit-playsinline=""
                   style="display:block;object-fit:cover;width:100%;height:100%;pointer-events:none;">
            </video>
        </div>
    </div>
    
    <th:block th:if="${theme.config.top.global_background.enable_global_background_img}">
        <style>
            @media screen and (min-width: 1300px) {
                .global_background_img {
                    width: 100%;
                    height: 100%;
                    top: 0;
                    left: 0;
                    opacity: 1;
                    position: fixed;
                    z-index: -999;
                    background: var(--heo-background);
                    background-attachment: fixed;
                    background-repeat: no-repeat;
                    background-size: cover;
                }
            }
            
            @media screen and (max-width: 1300px) {
                .global_background_img {
                    display: none;
                }
            }
        
        </style>
    </th:block>
    
    <script th:inline="javascript">
        
        function toRandomPost() {
            // éšæœºè·³è½¬é¦–é¡µçš„ä¸€ç¯‡æ–‡ç« 
            // åç»­æ”¹æˆè·³è½¬å…¨ç«™çš„æ–‡ç« ï¼Œå¯ä»¥ä» sitemap ä¸­è·å–æ‰€æœ‰æ–‡ç« 
            let posts = [[${posts}]];
            
            let datum = posts.total < posts.size ? posts.total : posts.size;
            
            let number = Math.floor(Math.random() * datum);
            
            let post = posts.items[number];
            
            // å½“å‰çª—å£æ‰“å¼€
            //window.location.href = post.status.permalink;
            pjax.loadUrl(post.status.permalink)
            // window.open(post.status.permalink);
        }
    
    </script>
    
    <!-- ç½‘ç«™èƒŒæ™¯ -->
    <div id="an_music_bg"></div>

<!-- æ§åˆ¶å° -->
<div th:replace="~{modules/widgets/console :: console}"></div>

<div th:replace="~{modules/sidebar :: sidebar}"></div>

<!-- å·¦ä¸‹è§’éŸ³ä¹ -->
<th:block th:if="${theme.config.tool.nav_music.nav_musicEnable}" >
    <div  th:replace="~{modules/widgets/nav-music :: nav-music}"></div>
</th:block>

<!-- å†…å®¹ -->
<th:block th:replace="${content}"></th:block>


<!-- todo å³ä¸‹è§’æ‚¬æµ®æ“ä½œæŒ‰é’® -->
<th:block th:replace="~{modules/common/rightside :: rightside}"></th:block>


<div th:replace="~{modules/right-menu :: right-menu}"></div>

<div>
    <script th:src="${assets_link + '/js/utils.js' + theme_version}"></script>
    <script th:src="${assets_link + '/js/main.js' + theme_version}"></script>
    <script charset="utf-8" data-pjax th:src="${assets_link + '/zhheo/blogex.js' + theme_version}"></script>
    <script th:src="${assets_link + '/js/tw_cn.js' + theme_version}"></script>
    <!-- https://instant.page/ ç½‘ç«™é¢„åŠ è½½ï¼Œ æ”¾åœ¨ 
<script>
// å°æ¿æŠ¥è®¿å®¢ä¿¡æ¯ IP æŸ¥è¯¢
(function () {
    const nsmaoKey = typeof GLOBAL_CONFIG !== 'undefined' && GLOBAL_CONFIG.source?.welcome?.key
        ? GLOBAL_CONFIG.source.welcome.key
        : '75gKybFM054DarMUAvMaVVtZjb';

    fetch(`https://api.nsmao.net/api/ip/query?key=${nsmaoKey}`)
        .then(res => res.json())
        .then(data => {
            if (data.code === 200 && data.data) {
                const info = data.data;
                const welcomeText = `æ¬¢è¿æ¥è‡ª ${info.country} ${info.prov} ${info.city} çš„æœ‹å‹ ğŸ‘‹`;
                const welcomeDiv = document.querySelector('#welcome-info');
                if (welcomeDiv) {
                    welcomeDiv.innerHTML = `<b>${welcomeText}</b>`;
                }
            }
        })
        .catch(err => console.error('å°æ¿æŠ¥ IP æ¥å£é”™è¯¯:', err));
})();
</script>

</body> ä¹‹å‰ -->
    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script>

    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script>

    <!-- å³ä¸‹è§’é€šçŸ¥ https://www.polonel.com/snackbar/ -->
    <!-- todo head ä¸­æœ‰å®ƒçš„ cssï¼Œåº”è¯¥å¯ä»¥å†™ä¸€å—ï¼Œå¹¶æ”¹æˆåå°å¯é…ç½®çš„åŠŸèƒ½ï¼Œä»£ç ä¸­åº”è¯¥è¿˜æœ‰ä»–çš„ js -->
    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/node-snackbar/0.1.16/snackbar.min.js"></script>

    <!-- æ·±è‰²æ¨¡å¼ä¸‹æ·»åŠ ç²’å­æ•ˆæœcanvas -->
    <canvas th:if="${theme.config.style.universe}" id="universe" width="1312" height="880"></canvas>
    <script th:if="${theme.config.style.universe}" async="" th:src="${assets_link + '/libs/canvas/dark.js'}"></script>

    <!-- https://davidshimjs.github.io/qrcodejs/ ç”ŸæˆäºŒç»´ç  -->
    <!-- åº”è¯¥æ˜¯æ–‡ç« é¡µåˆ†äº«ä½¿ç”¨ -->
    <script data-pjax src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- è¯„è®º -->
    <th:block th:if="${theme.config.comments.use!='commentWidget' && theme.config.comments.commentsEnable }"
              th:with="use = ${theme.config.comments.use}">
        <th:block th:replace="~{'modules/comment/' + ${use}}"></th:block>
        <script th:if="${theme.config.comments.visitorMail.visitorMailEnable}">var visitorMail = "[(${theme.config.comments.visitorMail.mail})]";</script>
    </th:block>
    <!--  https://raphamorim.io/waterfall.js/  åº”è¯¥æ˜¯è¿™ä¸ª è¿˜æœ‰ç›¸å…³çš„ js ä»£ç  æ˜¯å¦å¯ä»¥è°ƒæ•´-->
    <script th:src="${assets_link + '/libs/waterfall/waterfall.min.js'}"></script>

    <!-- è·å–ä¸»è‰² https://lokeshdhakar.com/projects/color-thief/ -->
    <!--<script th:src="@{/assets/libs/color-thief/color-thief.umd.js}"></script>-->
    <script th:src="${assets_link + '/libs/fast-average-color/index.browser.min.js'}"></script>

    <script th:src="${assets_link + '/libs/view-image/view-image.min.js'}"></script>

    <!--éŸ³ä¹-->
    <script>var meting_api = "[(${theme.config.tool.nav_music.meting_api})]"; </script>

    <link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="all" onload="this.media='all'">

    <script th:src="${assets_link + '/libs/aplayer/APlayer.min.js'}"></script>

    <script th:src="${assets_link + '/libs/aplayer/Meting2.min.js'}"></script>

    <script th:src="${assets_link + '/libs/pjax/pjax.min.js'}"></script>

    <!-- swiper åœ¨ç¬é—´æ»šåŠ¨æ—¶ä¼šä½¿ç”¨ -->
    <script th:if="${theme.config.top.moment}" data-pjax  src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/Swiper/6.6.2/swiper-bundle.min.js"></script>

    <!-- å³é”®èœå• -->
    <script th:if="${theme.config.tool.rightMenu.rightMenuEnable}" th:src="${assets_link + '/zhheo/rightmenu.js'}"></script>

    <!-- è¯„è®ºå¼¹å¹• -->
    <script  th:if="${ ( ( not #strings.isEmpty(theme.config.comments.twikoos.envId)  && not #strings.isEmpty(theme.config.comments.twikoos.accessToken) ) ||
        ( not #strings.isEmpty(theme.config.comments.artalks.server) && not #strings.isEmpty(theme.config.comments.artalks.siteName)) ||
          (#strings.equals(theme.config.comments.use, 'Waline') && not #strings.isEmpty(theme.config.comments.walines.serverURL)) )
        && theme.config.comments.commentBarrageConfig.commentBarrageEnable
        && theme.config.comments.commentsEnable}"  data-pjax=""
             th:src="${assets_link + '/zhheo/commentBarrage.js'}"></script>

    <!-- Tocbot ç›®å½•ç”Ÿæˆ start -->
    <th:block th:replace="~{modules/common/toc-bot :: toc-bot}"></th:block>

    <!-- 51ç»Ÿè®¡ -->
    <th:block th:replace="~{modules/common/51-la :: 51-la}"></th:block>

    <!--å®˜æ–¹è¯„è®ºæ’ä»¶js-->
    <script th:if="${pluginFinder.available('PluginCommentWidget')}" src="/plugins/PluginCommentWidget/assets/static/comment-widget.iife.js"></script>

    <div class="js-pjax">
        <!-- åŠ¨æ€æ ‡é¢˜ -->
        <script th:replace="~{modules/common/diytitle :: diytitle}"></script>
    </div>

    <script th:if="${theme.config.envelope_comment.enable_danmu}" th:src="${assets_link + '/libs/twikoo/easy-Danmaku.min.js'}" id="Danmaku"></script>



    <script>
        let pjaxSelectors = ['title', '#config-diff', '#body-wrap', '#rightside-config-hide', '#rightside-config-show', '.js-pjax','#site-config']

        if (false) {
            pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
        }

        var pjax = new Pjax({
            elements: 'a:not([target="_blank"])',
            selectors: pjaxSelectors,
            cacheBust: false,
            analytics: false,
            scrollRestoration: false
        })

        document.addEventListener('pjax:send', function () {

            // removeEventListener toc scroll
            window.removeEventListener('scroll', window.tocScrollFn)

            typeof preloader === 'object' && preloader.initLoading()

            if (window.aplayers) {
                for (let i = 0; i < window.aplayers.length; i++) {
                    if (!window.aplayers[i].options.fixed) {
                        window.aplayers[i].destroy()
                    }
                }
            }

            typeof typed === 'object' && typed.destroy()

            //reset readmode
            const $bodyClassList = document.body.classList
            $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
        })

        document.addEventListener('pjax:complete', function () {
            window.refreshFn()

            document.querySelectorAll('script[data-pjax]').forEach(item => {
                    const newScript = document.createElement('script')
                    const content = item.text || item.textContent || item.innerHTML || ""
                    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
                    newScript.appendChild(document.createTextNode(content))
                    item.parentNode.replaceChild(newScript, item)
                }
            )

            GLOBAL_CONFIG.lazyload.enable && window.lazyLoadInstance.update()

            typeof chatBtnFn === 'function' && chatBtnFn()
            typeof panguInit === 'function' && panguInit()

            // google analytics
            typeof gtag === 'function' && gtag('config', '', {
                'page_path': window.location.pathname
            });

            // baidu analytics
            typeof _hmt === 'object' && _hmt.push(['_trackPageview', window.location.pathname]);

            typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

            // Analytics
            if (false) {
                MtaH5.pgv()
            }

            // prismjs
            typeof Prism === 'object' && Prism.highlightAll()

            typeof preloader === 'object' && preloader.endLoading()
        })

        document.addEventListener('pjax:error', (e) => {
                if (e.request.status === 404 || e.request.status === 500) {
                    window.location.href = e.request.responseURL;
                }
            }
        )
    </script>


</div>

<!-- æ ¹æ®é…ç½®è®¾ç½® css å˜é‡å€¼ï¼Œå…¨å±€ css é€šè¿‡å˜é‡å€¼è¿›è¡Œå¤„ç† -->
<th:block th:replace="~{'modules/variables/layout'}"></th:block>

<script data-pjax="">

    if ([[${ theme.config.other.loadingBoxs.loadingBoxEnable }]]) {
        // ç§»é™¤åŠ è½½åŠ¨ç”»
        removeLoading();
    }
    //é¡µè„šå‹è”
    GLOBAL_CONFIG.isFriendLinksInFooter && heo.addFriendLinksInFooter()
    //éŸ³ä¹é¡µé¢åˆ‡æ¢æ­Œæ›²è°ƒç”¨
    if(GLOBAL_CONFIG.isMusic){
        heo.changeMusicBg(false);
    }
    //ä»£ç å—
    if(GLOBAL_CONFIG.prism.enable){
        halo.addPrismTool()
        halo.dataCodeTheme()
    }
    if(document.querySelector('#danmu') &&
        document.body.clientWidth > 768 &&
        [[${theme.config.envelope_comment.enable_danmu}]]){
        halo.addScript("Danmaku", "[[${assets_link + '/libs/twikoo/easy-Danmaku.min.js'}]]", halo.danmu())
    }

</script>

<script>
// å°æ¿æŠ¥è®¿å®¢ä¿¡æ¯ IP æŸ¥è¯¢
(function () {
    const nsmaoKey = typeof GLOBAL_CONFIG !== 'undefined' && GLOBAL_CONFIG.source?.welcome?.key
        ? GLOBAL_CONFIG.source.welcome.key
        : '75gKybFM054DarMUAvMaVVtZjb';

    fetch(`https://api.nsmao.net/api/ip/query?key=${nsmaoKey}`)
        .then(res => res.json())
        .then(data => {
            if (data.code === 200 && data.data) {
                const info = data.data;
                const welcomeText = `æ¬¢è¿æ¥è‡ª ${info.country} ${info.prov} ${info.city} çš„æœ‹å‹ ğŸ‘‹`;
                const welcomeDiv = document.querySelector('#welcome-info');
                if (welcomeDiv) {
                    welcomeDiv.innerHTML = `<b>${welcomeText}</b>`;
                }
            }
        })
        .catch(err => console.error('å°æ¿æŠ¥ IP æ¥å£é”™è¯¯:', err));
})();
</script>

</body>

</html>
