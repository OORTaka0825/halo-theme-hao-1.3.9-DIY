<!DOCTYPE html>
<html lang="en" th:fragment="layout(content, htmlType, title)" xmlns:th="http://www.thymeleaf.org"
      th:with="assets_link=${theme.config.other.staticResource.use == 'onmicrosoft' ? 'https://npm.onmicrosoft.cn/hao-theme-static@' + theme.spec.version +'/templates/assets' :
      theme.config.other.staticResource.use == 'cbd' ? 'https://cdn.cbd.int/hao-theme-static@' + theme.spec.version +'/templates/assets' :
      theme.config.other.staticResource.use == 'custom' ? theme.config.other.staticResource.cdn_link : #theme.assets('/')},
      theme_version = ${ theme.config.other.staticResource.use == 'local' ? '?v='+ theme.spec.version : ''},
      isLazyload = ${theme.config.other.vanillaLazyload.enable},
      loadingImg = ${theme.config.other.vanillaLazyload.loadingImg},
      siteTitle = ${not #strings.isEmpty(title) ?  title  :  #strings.isEmpty(site.subtitle) ? site.title :  site.title +' - ' +site.subtitle }">

<!-- head 中自定义的  -->

<head>
    <th:block th:replace="~{modules/head :: head(htmlType = ${htmlType})}"/>
    <link th:if="${#strings.equals(theme.config.comments.use, 'Waline')
    && not #strings.isEmpty(theme.config.comments.walines.serverURL)}"
          rel="stylesheet"
          th:href="${not #strings.isEmpty(theme.config.comments.walines.walinesCss) ? theme.config.comments.walines.walinesCss : 'https://cdn.cbd.int/@waline/client@2.15.7/dist/waline.css' }">
    <!--  解决 katex pjax问题 -->
    <script th:if="${pluginFinder.available('plugin-katex')}" defer=""
            src="/plugins/plugin-katex/assets/static/katex.min.js"></script>
    <script th:src="${assets_link + '/js/custom.js' + theme_version}"></script>
    <th:block th:if="${head != null}">
        <th:block th:replace="${head}"/>
    </th:block>

</head>

<body>

    <!-- loading 页面 -->
    <th:block th:replace="~{modules/loading-box}"/>
    
    <!-- 网站背景 -->
    <div id="web_bg">
        <div th:if="${theme.config.top.global_background.enable_global_background_img}">
            <img th:if="${theme.config.top.global_background.enable_global_background_above_video == false}"
                 class="global_background_img global_background_img--light"
                 th:src="${theme.config.top.global_background.global_background_img_light}"
            />
            <img th:if="${theme.config.top.global_background.enable_global_background_above_video == false}"
                 class="global_background_img global_background_img--dark"
                 th:src="${theme.config.top.global_background.global_background_img_dark}"
            />
            <video th:if="${theme.config.top.global_background.enable_global_background_above_video}"
                   class="index-video"
                   id="index-video"
                   autoplay=""
                   th:src="${theme.config.top.global_background.global_background_video}"
                   loop=""
                   muted=""
                   playsinline=""
                   webkit-playsinline=""
                   style="display:block;object-fit:cover;width:100%;height:100%;pointer-events:none;">
            </video>
        </div>
    </div>
    
    <th:block th:if="${theme.config.top.global_background.enable_global_background_img}">
        <style>
            @media screen and (min-width: 1300px) {
                .global_background_img {


                    width: 100%;
                    height: 100%;
                    top: 0;
                    left: 0;
                    opacity: 1;
                    position: fixed;
                    z-index: -999;
                    
                    background-attachment: fixed;
                    background-repeat: no-repeat;
                    background-size: cover;
                }
            }
            
            @media screen and (max-width: 1300px) {
                .global_background_img {
                    display: none;
                }
            }
        
        </style>
<style>
/* 明/暗主题切换不同背景图（不要放到 .global_background_img 的规则里） */
:root[data-theme='light'] .global_background_img--dark { display: none !important; }
:root[data-theme='dark']  .global_background_img--light { display: none !important; }
/* 兜底：部分实现下，亮色时不设置 data-theme */
html:not([data-theme='dark']) .global_background_img--dark { display: none !important; }
html[data-theme='dark']      .global_background_img--light { display: none !important; }
</style>

    </th:block>
    
    <script th:inline="javascript"
    th:with="allPostList=${postFinder.listAll()},
    randomIndex=${T(java.lang.Math).floor(T(java.lang.Math).random()*#lists.size(allPostList))},
    postPermalink=${allPostList[randomIndex].status.permalink}">
  function toRandomPost() {
    var permalink = /*[[${postPermalink}]]*/ "/";
    if (window.pjax && typeof pjax.loadUrl === 'function') {
      // 开启 PJAX：无刷新跳转
      pjax.loadUrl(permalink);
    } else {
      // 关闭 PJAX：整页跳转
      window.location.href = permalink;
    }
  }
</script>
    
    <!-- 网站背景 -->
    <div id="an_music_bg"></div>

<!-- 控制台 -->
<div th:replace="~{modules/widgets/console :: console}"></div>

<div th:replace="~{modules/sidebar :: sidebar}"></div>

<!-- 左下角音乐 -->
<th:block th:if="${theme.config.tool.nav_music.nav_musicEnable}">
    <div th:replace="~{modules/widgets/nav-music}"/>
</th:block>

<!-- 内容 -->
<th:block th:replace="${content}"></th:block>


<!-- todo 右下角悬浮操作按钮 -->
<th:block th:replace="~{modules/common/rightside :: rightside}"></th:block>


<div th:replace="~{modules/right-menu :: right-menu}"></div>

<div>
    <script th:src="${assets_link + '/js/utils.js' + theme_version}"></script>
    <script th:src="${assets_link + '/js/main.js' + theme_version}"></script>
    <script charset="utf-8" data-pjax th:src="${assets_link + '/zhheo/blogex.js' + theme_version}"></script>
    <script th:src="${assets_link + '/js/tw_cn.js' + theme_version}"></script>

<!-- 
    <!-- ===== Keep PJAX-like behavior when PJAX is OFF (append-only, v5) ===== -->
    <script th:if="${!theme.config.other.pjax_enable}">
    (function () {
      var KEY_PREFIX = 'hao:list:scroll:';
      var NAV_FLAG = 'hao:from:index_pagination';

      if ('scrollRestoration' in history) try { history.scrollRestoration = 'manual'; } catch (e) {}

      function saveScroll() {
        try {
          var key = KEY_PREFIX + location.pathname + location.search;
          sessionStorage.setItem(key, String(window.scrollY || document.documentElement.scrollTop || 0));
          // 记录：当前是否为分页页，从而“上一页”跳回首页时也能下滚
          sessionStorage.setItem(NAV_FLAG, isIndexPagination() ? '1' : '0');
        } catch (e) {}
      }
      addEventListener('beforeunload', saveScroll, { passive: true });
      addEventListener('pagehide', saveScroll, { passive: true });

      function restoreScrollIfAny() {
        try {
          var key = KEY_PREFIX + location.pathname + location.search;
          var y = sessionStorage.getItem(key);
          if (y !== null) requestAnimationFrame(function(){ scrollTo(0, parseInt(y,10) || 0); });
        } catch (e) {}
      }

      function pickListEl(){
        var sels = ['#home_top', '#recent-posts', '.recent-posts', '#content-inner'];
        for (var i=0;i<sels.length;i++){
          var el = document.querySelector(sels[i]);
          if (el) return el;
        }
        return null;
      }

      function scrollToListSmooth() {
        var el = pickListEl();
        if (!el) return;
        if (window.btf && typeof window.btf.scrollToDest === 'function') {
          window.btf.scrollToDest(el.offsetTop, 500); // 主题内部会 -70
          return;
        }
        if (window.heo && window.heo.scroll && typeof window.heo.scroll.homeToList === 'function'){
          try { window.heo.scroll.homeToList(); return; } catch(e){}
        }
        var y = el.getBoundingClientRect().top + pageYOffset - 70;
        try { scrollTo({ top: Math.max(0, y), behavior: 'smooth' }); }
        catch (e) { scrollTo(0, Math.max(0, y)); }
      }

      function isIndexPagination() {
        if (/\/page\/\d+\/?$/i.test(location.pathname)) return true;
        if (/[?&]page=\d+/i.test(location.search)) return true;
        return false;
      }

      function isHomeLike(){
        // 首页（上一页可能从 /page/2 跳回 / 或 ?page=1）
        if (location.pathname === '/' || location.pathname === '') return true;
        if (/[?&]page=1\b/i.test(location.search)) return true;
        return false;
      }

      function cameFromPagination(){
        try { return sessionStorage.getItem(NAV_FLAG) === '1'; } catch(e){}
        return false;
      }

      function clearNavFlag(){ try { sessionStorage.removeItem(NAV_FLAG); } catch(e){} }

      function isBackForwardNav() {
        try { 
          var entries = performance.getEntriesByType && performance.getEntriesByType('navigation');
          if (entries && entries[0]) return entries[0].type === 'back_forward';
        } catch (e) {}
        return false;
      }

      addEventListener('pageshow', function (ev) {
        // 回退：恢复滚动位置
        if (ev.persisted || isBackForwardNav()) { restoreScrollIfAny(); clearNavFlag(); return; }

        // 正常进入：分页页直接滚动；或者从分页回到首页也滚动
        if (isIndexPagination() || (isHomeLike() && cameFromPagination())) {
          setTimeout(scrollToListSmooth, 60);
        }
        clearNavFlag();
      }, { passive: true });

      document.addEventListener('DOMContentLoaded', function () {
        if (isIndexPagination() || (isHomeLike() && cameFromPagination())) {
          setTimeout(scrollToListSmooth, 0);
        }
      });
    })();
    </script>

    <script src="/themes/theme-hao/assets/libs/instantpage.min.js" type="module"></script>

    <script th:src="${assets_link + '/libs/vanilla-lazyload/lazyload.iife.min.js'}"></script>

    <!-- 右下角通知 /themes/theme-hao/assets/libs/ -->
    <!-- todo head 中有它的 css，应该可以写一块，并改成后台可配置的功能，代码中应该还有他的 js -->
    <script src="/themes/theme-hao/assets/libs/snackbar.min.js"></script>

    <!-- 深色模式下添加粒子效果canvas -->
    <canvas th:if="${theme.config.style.universe}" id="universe" width="1312" height="880"></canvas>
    <script th:if="${theme.config.style.universe}" async="" th:src="${assets_link + '/libs/canvas/dark.js'}"></script>

    <!-- https://davidshimjs.github.io/qrcodejs/ 生成二维码 -->
    <!-- 应该是文章页分享使用 -->
    <script data-pjax src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- 评论 -->
    <th:block th:if="${theme.config.comments.use!='commentWidget' && theme.config.comments.commentsEnable }"
              th:with="use = ${theme.config.comments.use}">
        <th:block th:replace="~{'modules/comment/' + ${use}}"></th:block>
        <script th:if="${theme.config.comments.visitorMail.visitorMailEnable}">var visitorMail = "[(${theme.config.comments.visitorMail.mail})]";</script>
    </th:block>
    <!--  https://raphamorim.io/waterfall.js/  应该是这个 还有相关的 js 代码 是否可以调整-->
    <script th:src="${assets_link + '/libs/waterfall/waterfall.min.js'}"></script>

    <!-- 获取主色 https://lokeshdhakar.com/projects/color-thief/ -->
    <!--<script th:src="@{/assets/libs/color-thief/color-thief.umd.js}"></script>-->
    <script th:src="${assets_link + '/libs/fast-average-color/index.browser.min.js'}"></script>

    <script th:src="${assets_link + '/libs/view-image/view-image.min.js'}"></script>

    <!--音乐-->
    <script>var meting_api = "[(${theme.config.tool.nav_music.meting_api})]"; </script>

    <link rel="stylesheet" th:href="${assets_link + '/libs/aplayer/APlayer.min.css'}"
          media="all" onload="this.media='all'">

    <script th:src="${assets_link + '/libs/aplayer/APlayer.min.js'}"></script>
    
    <script th:src="${assets_link + '/libs/aplayer/Meting2.min.js'}"></script>
    
    <script th:if="${theme.config.other.pjax_enable}"
        th:src="${assets_link + '/libs/pjax/pjax.min.js'}"></script>

    <!-- swiper 在瞬间滚动时会使用 -->
    <script th:if="${theme.config.top.moment}" data-pjax  src="/themes/theme-hao/assets/libs/swiper-bundle.min.js"></script>

    <!-- 右键菜单 -->
    <script th:if="${theme.config.tool.rightMenu.rightMenuEnable}" th:src="${assets_link + '/zhheo/rightmenu.js'}"></script>

    <!-- 评论弹幕 -->
    <script  th:if="${ ( ( not #strings.isEmpty(theme.config.comments.twikoos.envId)  && not #strings.isEmpty(theme.config.comments.twikoos.accessToken) ) ||
        ( not #strings.isEmpty(theme.config.comments.artalks.server) && not #strings.isEmpty(theme.config.comments.artalks.siteName)) ||
          (#strings.equals(theme.config.comments.use, 'Waline') && not #strings.isEmpty(theme.config.comments.walines.serverURL)) )
        && theme.config.comments.commentBarrageConfig.commentBarrageEnable
        && theme.config.comments.commentsEnable}"  data-pjax=""
             th:src="${assets_link + '/zhheo/commentBarrage.js'}"></script>

    <!-- Tocbot 目录生成 start -->
    <th:block th:replace="~{modules/common/toc-bot :: toc-bot}"></th:block>

    <!-- 51统计 -->
    <th:block th:replace="~{modules/common/51-la}"/>

    <!--官方评论插件js-->
    <script th:if="${pluginFinder.available('PluginCommentWidget')}" src="/plugins/PluginCommentWidget/assets/static/comment-widget.iife.js"></script>

    <div class="js-pjax">
        <!-- 动态标题 -->
        <script th:replace="~{modules/common/diytitle :: diytitle}"></script>
    </div>

    <script th:if="${theme.config.envelope_comment.enable_danmu}" th:src="${assets_link + '/libs/twikoo/easy-Danmaku.min.js'}" id="Danmaku"></script>



    <th:block th:if="${theme.config.other.pjax_enable}"><script>
        let pjaxSelectors = ['title', '#config-diff', '#body-wrap', '#rightside-config-hide', '#rightside-config-show', '.js-pjax', '#site-config']
        
        pjaxSelectors.unshift('meta[property="og:type"]', 'meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]', 'meta[property="og:description"]'
                , 'meta[name="twitter:title"]', 'meta[name="twitter:url"]', 'meta[name="twitter:description"]', 'meta[name="twitter:image"]')
        
        var pjax = new Pjax({
            elements: 'a:not([target="_blank"])',
            selectors: pjaxSelectors,
            cacheBust: false,
            analytics: false,
            scrollRestoration: false
        })
        
        document.addEventListener('pjax:send', function () {
            
            // removeEventListener toc scroll
            window.removeEventListener('scroll', window.tocScrollFn)
            
            typeof preloader === 'object' && preloader.initLoading()
            
            if (window.aplayers) {
                for (let i = 0; i < window.aplayers.length; i++) {
                    if (!window.aplayers[i].options.fixed) {
                        window.aplayers[i].destroy()
                    }
                }
            }
            
            typeof typed === 'object' && typed.destroy()
            
            //reset readmode
            const $bodyClassList = document.body.classList
            $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
        })
        
        document.addEventListener('pjax:complete', function () {
            window.refreshFn()
            
            document.querySelectorAll('script[data-pjax]').forEach(item => {
                        const newScript = document.createElement('script')
                        const content = item.text || item.textContent || item.innerHTML || ""
                        Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
                        newScript.appendChild(document.createTextNode(content))
                        item.parentNode.replaceChild(newScript, item)
                    }
            )
            
            GLOBAL_CONFIG.lazyload.enable && window.lazyLoadInstance.update()
            
            typeof chatBtnFn === 'function' && chatBtnFn()
            typeof panguInit === 'function' && panguInit()
            
            // google analytics
            typeof gtag === 'function' && gtag('config', '', {
                'page_path': window.location.pathname
            });
            
            // baidu analytics
            typeof _hmt === 'object' && _hmt.push(['_trackPageview', window.location.pathname]);
            
            typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
            
            // Analytics
            if (false) {
                MtaH5.pgv()
            }
            
            // prismjs
            typeof Prism === 'object' && Prism.highlightAll()
            
            typeof preloader === 'object' && preloader.endLoading()
        })
        
        document.addEventListener('pjax:error', (e) => {
                    if (e.request.status === 404 || e.request.status === 500) {
                        window.location.href = e.request.responseURL;
                    }
                }
        )
    </script></th:block>


</div>

<!-- 根据配置设置 css 变量值，全局 css 通过变量值进行处理 -->
<th:block th:replace="~{'modules/variables/layout'}"></th:block>

<script data-pjax="">

    if ([[${ theme.config.other.loadingBoxs.loadingBoxEnable }]]) {
        // 移除加载动画
        removeLoading();
    }
    //页脚友联
    GLOBAL_CONFIG.isFriendLinksInFooter && heo.addFriendLinksInFooter()
    //音乐页面切换歌曲调用
    if(GLOBAL_CONFIG.isMusic){
        heo.changeMusicBg(false);
    }
    //代码块
    if(GLOBAL_CONFIG.prism.enable){
        halo.addPrismTool()
        halo.dataCodeTheme()
    }
    if(document.querySelector('#danmu') &&
        document.body.clientWidth > 768 &&
        [[${theme.config.envelope_comment.enable_danmu}]]){
        halo.addScript("Danmaku", "[[${assets_link + '/libs/twikoo/easy-Danmaku.min.js'}]]", halo.danmu())
    }
</script>

<script>
(function(){
  if (window._haoScrollNoFlashInit) return;
  window._haoScrollNoFlashInit = true;

  var POS_PREFIX = 'hao:scroll:';          // 每个 path 的位置
  var STATE_KEY  = 'hao:restore_state';    // 是否处于“正在恢复”状态：'1'|'0'
  var CURRENT_KEY = null;
  var isPop = false;
  var restoring = false;
  var saveTicking = false;
  var rafId = 0;
  var timeoutIds = [];

  function pageKey(){ return location.pathname + location.search; }
  function getY(){ return window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0; }
  function setPos(k,v){ try{ sessionStorage.setItem(POS_PREFIX + k, String(v)); }catch(e){} }
  function getPos(k){ try{ return sessionStorage.getItem(POS_PREFIX + k); }catch(e){ return null; } }
  function rmPos(k){ try{ sessionStorage.removeItem(POS_PREFIX + k); }catch(e){} }
  function setState(v){ try{ sessionStorage.setItem(STATE_KEY, v ? '1':'0'); }catch(e){} }
  function getState(){ try{ return sessionStorage.getItem(STATE_KEY) === '1'; }catch(e){ return false; } }

  function isListPage(){
    var bw = document.getElementById('body-wrap');
    return !!(bw && bw.classList && bw.classList.contains('page'));
  }
  function isPostPage(){
    var bw = document.getElementById('body-wrap');
    return !!(bw && bw.classList && bw.classList.contains('post'));
  }

  function throttledSave(){
    if (!isListPage()) return;     // 只在列表页保存
    if (restoring) return;
    if (saveTicking) return;
    saveTicking = true;
    requestAnimationFrame(function(){
      var k = CURRENT_KEY || pageKey();
      setPos(k, getY());
      saveTicking = false;
    });
  }

  function hardWrapScrollHelpers(){
    try{
      if (typeof window.scrollToPost === 'function' && !window._scrollToPostWrappedNoFlash){
        var orig = window.scrollToPost;
        window.scrollToPost = function(){
          if (getState()) return;  // 仅在“正在恢复”时拦截；平时不拦
          return orig.apply(this, arguments);
        };
        window._scrollToPostWrappedNoFlash = true;
      }
    }catch(e){}
    try{
      if (window.btf && typeof window.btf.scrollToDest === 'function' && !window.btf._scrollToDestWrappedNoFlash){
        var orig2 = window.btf.scrollToDest;
        window.btf.scrollToDest = function(){
          if (getState()) return;
          return orig2.apply(this, arguments);
        };
        window.btf._scrollToDestWrappedNoFlash = true;
      }
    }catch(e){}
  }

  function patchPjaxLoadUrl(){
    try{
      if (window.pjax && !window.pjax._haoSavePatchedNoFlash){
        var orig = window.pjax.loadUrl;
        window.pjax.loadUrl = function(url){
          try{ if (isListPage()) setPos(pageKey(), getY()); }catch(e){}
          cancelRestore(true);     // 新导航前取消任何恢复
          setState(false);         // 普通前进导航，确保不拦截 scrollToPost
          return orig.apply(this, arguments);
        };
        window.pjax._haoSavePatchedNoFlash = true;
      }
    }catch(e){}
  }

  function cancelRestore(fromNav){
    restoring = false;
    if (rafId) { try{ cancelAnimationFrame(rafId); }catch(e){} rafId = 0; }
    while (timeoutIds.length) { try{ clearTimeout(timeoutIds.pop()); }catch(e){} }
    // 只在“非用户主动操作”时还原 scroll-behavior；用户操作取消恢复会立即允许平滑滚动
    if (!fromNav) { try { document.documentElement.style.scrollBehavior = ''; } catch(e){} }
    setState(false);
  }

  // 用户主动滚动/键盘时，立即取消恢复，避免“抢拉动”感
  ['wheel','touchstart','touchmove','keydown','mousedown'].forEach(function(evt){
    window.addEventListener(evt, function(){
      if (restoring) cancelRestore(false);
    }, {passive:true});
  });

  // 检测浏览器后退/前进
  window.addEventListener('popstate', function(){ isPop = true; }, true);

  // 滚动保存（仅列表页）
  window.addEventListener('scroll', throttledSave, {passive:true});

  // 离开前再保存一次（仅列表页）
  window.addEventListener('beforeunload', function(){ if (isListPage()) setPos(pageKey(), getY()); });

  document.addEventListener('pjax:send', function(){
    cancelRestore(true);   // 导航前取消遗留恢复，避免文章页打开在中间
  });

  document.addEventListener('pjax:complete', function(){
    CURRENT_KEY = pageKey();
    patchPjaxLoadUrl();
    hardWrapScrollHelpers();

    if (isPostPage()){
      if (!location.hash){
        window.scrollTo(0,0);
        timeoutIds.push(setTimeout(function(){ window.scrollTo(0,0); }, 60));
      }
      return;
    }

    if (!isListPage()) return;

    if (isPop){
      var v = getPos(CURRENT_KEY);
      if (v != null){
        startRestore(parseInt(v,10) || 0);
        rmPos(CURRENT_KEY);
      }
      isPop = false;
    }
  });

  // 支持 BFCache
  window.addEventListener('pageshow', function(ev){
    CURRENT_KEY = pageKey();
    patchPjaxLoadUrl();
    hardWrapScrollHelpers();

    if (isPostPage()){
      if (!location.hash){
        window.scrollTo(0,0);
        timeoutIds.push(setTimeout(function(){ window.scrollTo(0,0); }, 60));
      }
      return;
    }

    if (!isListPage()) return;
    if (ev && ev.persisted){
      var v = getPos(CURRENT_KEY);
      if (v != null){
        startRestore(parseInt(v,10) || 0);
        rmPos(CURRENT_KEY);
      }
    }
  });

  function startRestore(y){
    restoring = true;
    setState(true);  // 在恢复阶段屏蔽主题滚动动画

    var prevBehavior = document.documentElement.style.scrollBehavior;
    document.documentElement.style.scrollBehavior = 'auto';

    var start = performance.now();
    var lastHeight = document.body.scrollHeight;
    var stableFrames = 0;
    var EPS = 2;          // 误差阈值（像素）
    var MAX_MS = 1200;    // 最长恢复时间
    var MAX_RAF = 40;     // 最多帧数

    function done(){
      document.documentElement.style.scrollBehavior = prevBehavior || '';
      restoring = false;
      setState(false);
      if (rafId) { try{ cancelAnimationFrame(rafId); }catch(e){} rafId = 0; }
      while (timeoutIds.length) { try{ clearTimeout(timeoutIds.pop()); }catch(e){} }
    }

    function rafTick(){
      var now = performance.now();
      var cur = getY();
      var h = document.body.scrollHeight;

      // 若内容高度稳定且位置已接近目标，提前结束（避免继续“抢动”）
      if (Math.abs(cur - y) <= EPS){
        stableFrames++;
        if (stableFrames >= 3){ return done(); }
      } else {
        stableFrames = 0;
      }

      // 若页面高度变化，说明懒加载/布局在动，继续校正
      if (h !== lastHeight){
        lastHeight = h;
        stableFrames = 0;
      }

      window.scrollTo(0, y);

      if ((now - start) >= MAX_MS) return done();
      if (--MAX_RAF <= 0) return done();

      rafId = requestAnimationFrame(rafTick);
    }

    rafId = requestAnimationFrame(rafTick);

    // 少量兜底（不影响提前结束）：
    [200, 500, 900].forEach(function(ms){
      var tid = setTimeout(function(){
        if (restoring) window.scrollTo(0, y);
      }, ms);
      timeoutIds.push(tid);
    });
  }

  if ('scrollRestoration' in history) history.scrollRestoration = 'manual';
  CURRENT_KEY = pageKey();
  patchPjaxLoadUrl();
  hardWrapScrollHelpers();
  setState(false);
})();
</script>


    <!-- ===== Keep PJAX-like behavior when PJAX is OFF (append-only, v5) ===== -->
    <script th:if="${!theme.config.other.pjax_enable}">
    (function () {
      var KEY_PREFIX = 'hao:list:scroll:';
      var NAV_FLAG = 'hao:from:index_pagination';

      if ('scrollRestoration' in history) try { history.scrollRestoration = 'manual'; } catch (e) {}

      function saveScroll() {
        try {
          var key = KEY_PREFIX + location.pathname + location.search;
          sessionStorage.setItem(key, String(window.scrollY || document.documentElement.scrollTop || 0));
          // 记录：当前是否为分页页，从而“上一页”跳回首页时也能下滚
          sessionStorage.setItem(NAV_FLAG, isIndexPagination() ? '1' : '0');
        } catch (e) {}
      }
      addEventListener('beforeunload', saveScroll, { passive: true });
      addEventListener('pagehide', saveScroll, { passive: true });

      function restoreScrollIfAny() {
        try {
          var key = KEY_PREFIX + location.pathname + location.search;
          var y = sessionStorage.getItem(key);
          if (y !== null) requestAnimationFrame(function(){ scrollTo(0, parseInt(y,10) || 0); });
        } catch (e) {}
      }

      function pickListEl(){
        var sels = ['#home_top', '#recent-posts', '.recent-posts', '#content-inner'];
        for (var i=0;i<sels.length;i++){
          var el = document.querySelector(sels[i]);
          if (el) return el;
        }
        return null;
      }

      function scrollToListSmooth() {
        var el = pickListEl();
        if (!el) return;
        if (window.btf && typeof window.btf.scrollToDest === 'function') {
          window.btf.scrollToDest(el.offsetTop, 500); // 主题内部会 -70
          return;
        }
        if (window.heo && window.heo.scroll && typeof window.heo.scroll.homeToList === 'function'){
          try { window.heo.scroll.homeToList(); return; } catch(e){}
        }
        var y = el.getBoundingClientRect().top + pageYOffset - 70;
        try { scrollTo({ top: Math.max(0, y), behavior: 'smooth' }); }
        catch (e) { scrollTo(0, Math.max(0, y)); }
      }

      function isIndexPagination() {
        if (/\/page\/\d+\/?$/i.test(location.pathname)) return true;
        if (/[?&]page=\d+/i.test(location.search)) return true;
        return false;
      }

      function isHomeLike(){
        // 首页（上一页可能从 /page/2 跳回 / 或 ?page=1）
        if (location.pathname === '/' || location.pathname === '') return true;
        if (/[?&]page=1\b/i.test(location.search)) return true;
        return false;
      }

      function cameFromPagination(){
        try { return sessionStorage.getItem(NAV_FLAG) === '1'; } catch(e){}
        return false;
      }

      function clearNavFlag(){ try { sessionStorage.removeItem(NAV_FLAG); } catch(e){} }

      function isBackForwardNav() {
        try { 
          var entries = performance.getEntriesByType && performance.getEntriesByType('navigation');
          if (entries && entries[0]) return entries[0].type === 'back_forward';
        } catch (e) {}
        return false;
      }

      addEventListener('pageshow', function (ev) {
        // 回退：恢复滚动位置
        if (ev.persisted || isBackForwardNav()) { restoreScrollIfAny(); clearNavFlag(); return; }

        // 正常进入：分页页直接滚动；或者从分页回到首页也滚动
        if (isIndexPagination() || (isHomeLike() && cameFromPagination())) {
          setTimeout(scrollToListSmooth, 60);
        }
        clearNavFlag();
      }, { passive: true });

      document.addEventListener('DOMContentLoaded', function () {
        if (isIndexPagination() || (isHomeLike() && cameFromPagination())) {
          setTimeout(scrollToListSmooth, 0);
        }
      });
    })();
    </script>


<!-- 鼠标风格 -->
<script th:inline="javascript">
  (function(){
    const ASSETS = /*[[${assets_link}]]*/ '/assets';
    const THEME_VER = /*[[${theme_version}]]*/ '';
    const CFG = {
      cursor_style: /*[[${theme.config.style.cursor_style}]]*/ 'none'
    };

    if (window.__DIY_CURSOR_STYLE_V12__) return;
    window.__DIY_CURSOR_STYLE_V12__ = true;

    if (CFG.cursor_style && CFG.cursor_style !== 'none') {
      var pack = CFG.cursor_style, base = ASSETS + '/cursor/' + pack + '/';
      function urlq(n){ try{return 'url("' + encodeURI(base+n) + '")'}catch(e){return 'url(' + base+n + ')'} }
      function urls(list){ return list.map(urlq).join(','); }
      var css = [
        'html, body { cursor: ' + urls(['arrow.cur','Arrow.cur','Normal.cur','normal.cur','Arrow.ani','Normal.ani']) + ', auto !important; }',
        'a, button, [role="button"], input[type=button], input[type=submit] { cursor: ' + urls(['hand.cur','Hand.cur','link.cur','Link.cur','hand.ani','Link.ani','Alternate Select.cur','alternate.cur']) + ', pointer !important; }',
        'input[type=text], input[type=search], textarea, .text, .textbox, .input { cursor: ' + urls(['ibeam.cur','IBeam.cur','beam.cur','Beam.cur','text.cur','Text.cur','ibeam.ani','Escritura a Mano.cur','Handwriting.cur','texto.cur']) + ', text !important; }'
      ].join('\n');
      var st = document.createElement('style');
      st.textContent = css;
      document.head.appendChild(st);
    }
  })();
</script>

<!-- 鼠标移动和点击特效（仅第二段；与明暗无关；避免被第三段清理） -->
<script th:inline="javascript">
(function(){
  // —— 只处理鼠标移动/点击，不改显示模式 —— 
  const ASSETS = /*[[${assets_link}]]*/ '/assets';
  const THEME_VER = /*[[${theme_version}]]*/ '';
  const CFG = {
    cursor_move:  /*[[${theme.config.style.cursor_move}]]*/  'none',
    cursor_click: /*[[${theme.config.style.cursor_click}]]*/ 'none'
  };

  if (window.__DIY_MOUSE_SEG2__) return;
  window.__DIY_MOUSE_SEG2__ = true;

  // 1) 建一个“鼠标容器”，带 data-keep-canvas，第三段的清理会自动跳过它
  function 确保鼠标容器(){
    let box = document.getElementById('diy-mouse-box');
    if (!box){
      box = document.createElement('div');
      box.id = 'diy-mouse-box';
      box.setAttribute('data-keep-canvas','mouse');     // 关键：让第三段 purge 跳过
      box.style.cssText='pointer-events:none;position:fixed;inset:0;z-index:0';
      document.body.appendChild(box);
    }
    return box;
  }

  // 2) 只在短时间内“拦截”新节点，把鼠标画布收入容器（避免先被第三段清掉）
  function 短时拦截追加(ms){
    const 截止 = Date.now() + (ms||3000);
    const 原append = Node.prototype.appendChild;
    const 原insert = Node.prototype.insertBefore;
    const 盒 = 确保鼠标容器();

    function 是鼠标节点(n){
      if (!(n instanceof HTMLElement) && !(n instanceof HTMLCanvasElement)) return false;
      const s = ((n.id||'')+' '+(n.className||'')).toLowerCase();
      return /cursor|trail|ribbon|click|firework|particle|spark/.test(s) || n.tagName==='CANVAS';
    }
    function 路由(node,parent){
      if (Date.now()>截止) return false;
      if (parent!==document.body) return false;
      if (!是鼠标节点(node)) return false;
      // 到这里基本是鼠标画布或相关容器
      盒.appendChild(node);
      if (node.tagName==='CANVAS'){
        标记鼠标画布(node);
      }else{
        // 如果是 div/svg，内部的 canvas 也标一下
        try{ node.querySelectorAll && node.querySelectorAll('canvas').forEach(标记鼠标画布); }catch(e){}
      }
      return true;
    }

    Node.prototype.appendChild = function(n){
      if (路由(n,this)) return n;
      return 原append.call(this,n);
    };
    Node.prototype.insertBefore = function(n,ref){
      if (路由(n,this)) return n;
      return 原insert.call(this,n,ref);
    };

    // 到时还原
    setTimeout(function(){
      Node.prototype.appendChild = 原append;
      Node.prototype.insertBefore = 原insert;
    }, (ms||3000)+50);
  }

  // 3) 标记鼠标画布（让第三段的“大画布兜底删除”也跳过）
  function 标记鼠标画布(cv){
    try{
      const s = ((cv.id||'')+' '+(cv.className||'')).toLowerCase();
      if (/cursor|trail|ribbon/.test(s)) cv.dataset.diyMouse = 'move';
      if (/click|firework|particle|spark/.test(s)) cv.dataset.diyMouse = 'click';
      cv.setAttribute('data-keep-canvas','mouse');   // 关键
      cv.style.pointerEvents='none';
    }catch(e){}
  }

  // 4) 把页面上已有的鼠标画布收编进容器
  function 初始收编(){
    const 盒 = 确保鼠标容器();
    document.querySelectorAll('canvas').forEach(function(cv){
      const s = ((cv.id||'')+' '+(cv.className||'')).toLowerCase();
      if (/cursor|trail|ribbon|click|firework|particle|spark/.test(s)){
        标记鼠标画布(cv);
        if (cv.parentNode===document.body) 盒.appendChild(cv);
      }
    });
  }

  // 5) 监听后续新增，把鼠标画布移入容器并打标
  const 观察 = new MutationObserver(function(muts){
    const 盒 = document.getElementById('diy-mouse-box') || 确保鼠标容器();
    muts.forEach(function(m){
      (m.addedNodes||[]).forEach(function(n){
        if (n instanceof HTMLCanvasElement){
          标记鼠标画布(n);
          if (n.parentNode===document.body) 盒.appendChild(n);
        }else if (n instanceof HTMLElement && n.querySelectorAll){
          n.querySelectorAll('canvas').forEach(function(cv){
            const s = ((cv.id||'')+' '+(cv.className||'')).toLowerCase();
            if (/cursor|trail|ribbon|click|firework|particle|spark/.test(s)){
              标记鼠标画布(cv);
              if (cv.parentNode===document.body) 盒.appendChild(cv);
            }
          });
        }
      });
    });
  });

  // 6) 只在缺失时加载一次脚本（与明暗无关）
  function 已有移动画布(){
    return !!document.querySelector('#diy-mouse-box canvas[data-diyMouse="move"], #diy-mouse-box canvas[id*="cursor"], #diy-mouse-box canvas[class*="cursor"], #diy-mouse-box canvas[id*="trail"], #diy-mouse-box canvas[class*="trail"], #diy-mouse-box canvas[id*="ribbon"], #diy-mouse-box canvas[class*="ribbon"]');
  }
  function 已有点击画布(){
    return !!document.querySelector('#diy-mouse-box canvas[data-diyMouse="click"], #diy-mouse-box canvas[id*="click"], #diy-mouse-box canvas[class*="click"], #diy-mouse-box canvas[id*="firework"], #diy-mouse-box canvas[class*="firework"], #diy-mouse-box canvas[id*="particle"], #diy-mouse-box canvas[class*="particle"], #diy-mouse-box canvas[id*="spark"], #diy-mouse-box canvas[class*="spark"]');
  }
  function 加载一次(类型, 名称){
    if (!名称 || 名称==='none') return;
    const 键 = '__DIY_MOUSE_LOAD__'+类型;
    if (window[键]) return;
    window[键] = 1;
    const s = document.createElement('script');
    s.defer = true;
    s.src = ASSETS + (类型==='move' ? '/js/cursor/move/'+名称+'.min.js' : '/js/cursor/click/'+名称+'.min.js') + THEME_VER;
    document.body.appendChild(s);
  }
  function 取包名(){
    let 移动 = CFG.cursor_move || '', 点击 = CFG.cursor_click || '';
    if ((!移动 || !点击) && window.DreamConfig){
      if (!移动 && window.DreamConfig.cursor_move)  移动 = window.DreamConfig.cursor_move;
      if (!点击 && window.DreamConfig.cursor_click) 点击 = window.DreamConfig.cursor_click;
    }
    if (!移动 || !点击){
      Array.from(document.scripts).forEach(function(s){
        const src = s.getAttribute('src')||'';
        if (!移动){
          const m = src.match(/\/js\/cursor\/move\/([^\/]+)\.min\.js/i);
          if (m) 移动 = m[1];
        }
        if (!点击){
          const c = src.match(/\/js\/cursor\/click\/([^\/]+)\.min\.js/i);
          if (c) 点击 = c[1];
        }
      });
    }
    return {移动, 点击};
  }
  function 保活(){
    const {移动, 点击} = 取包名();
    if (!已有移动画布()  && 移动) 加载一次('move',  移动);
    if (!已有点击画布() && 点击) 加载一次('click', 点击);
  }

  // 7) 启动顺序：先建容器→短时拦截→加载脚本→初始收编→监听→保活
  function 启动(){
    确保鼠标容器();
    短时拦截追加(3000);           // 保证鼠标脚本创建的画布直接进容器
    const {移动, 点击} = 取包名();
    if (移动 && 移动!=='none') 加载一次('move', 移动);
    if (点击 && 点击!=='none') 加载一次('click', 点击);

    初始收编();
    try{ 观察.observe(document.body,{childList:true,subtree:true}); }catch(e){}
    保活();

    // 主题切换或 storage 变化时，只做保活（不触碰显示模式）
    const moTheme = new MutationObserver(function(){ requestAnimationFrame(保活); });
    moTheme.observe(document.documentElement,{attributes:true,attributeFilter:['class','data-theme','theme']});
    window.addEventListener('storage', function(){ requestAnimationFrame(保活); });

    // 兜底定时
    setInterval(保活, 1500);
  }

  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', 启动);
  else 启动();
})();
</script>


<!-- 6个显示模式 -->
<script th:inline="javascript">
  (function(){
    const ASSETS = /*[[${assets_link}]]*/ '/assets';
    const THEME_VER = /*[[${theme_version}]]*/ '';

    const CFG = {
      effects_lantern_mode:        /*[[${theme.config.style.effects_lantern_mode}]]*/ 'none',
      effects_sakura_mode:         /*[[${theme.config.style.effects_sakura_mode}]]*/ 'none',
      effects_snowflake_mode:      /*[[${theme.config.style.effects_snowflake_mode}]]*/ 'none',
      effects_universe_mode:       /*[[${theme.config.style.effects_universe_mode}]]*/ 'none',
      effects_circle_magic_mode:   /*[[${theme.config.style.effects_circle_magic_mode}]]*/ 'none',
      effects_quantum_silk_thread_mode: /*[[${theme.config.style.effects_quantum_silk_thread_mode}]]*/ 'none'
    };

    // 量子丝线图片（DIY 主题路径）
    window.DIY_WORDLINE_IMG = ASSETS + '/images/wordline.webp';

    // ---------- helpers ----------
    function normMode(v){
      const s=(v||'').toString().trim().toLowerCase();
      if(['明亮模式','亮','light','day','浅色','白天'].includes(s)) return 'light';
      if(['黑暗模式','暗','dark','night','深色','夜间'].includes(s)) return 'dark';
      if(['全模式','全部','all'].includes(s)) return 'all';
      if(['不显示','关闭','none','off'].includes(s)) return 'none';
      return s||'none';
    }
    const toDayNight = m => (m==='light'?'day':(m==='dark'?'night':m));

    function getCurrentScheme(){
      const html=document.documentElement;
      const attr=(html.getAttribute('data-theme')||html.getAttribute('theme')||'').toLowerCase();
      if(attr==='dark') return 'dark';
      if(html.classList.contains('dark')) return 'dark';
      const ls=(localStorage.getItem('theme')||localStorage.getItem('special-efficacy-scheme')||'').toLowerCase();
      if(ls==='dark'||ls==='night') return 'dark';
      if(window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches) return 'dark';
      return 'light';
    }
    function syncScheme(){
      const isDark = getCurrentScheme()==='dark';
      document.documentElement.classList.toggle('night', isDark);
      try{ localStorage.setItem('special-efficacy-scheme', isDark ? 'dark' : 'light'); }catch(e){}
    }
    function whenReady(cb){
      let tries=0;(function tick(){
        const ready=document.documentElement.getAttribute('data-theme')
              ||document.documentElement.classList.contains('dark')
              ||localStorage.getItem('theme')
              ||localStorage.getItem('special-efficacy-scheme');
        if(ready||tries>40) return cb(); tries++; setTimeout(tick,50);
      })();
    }
    function loadJS(src){
      const s=document.createElement('script');
      s.src=src+THEME_VER+'&r='+(Math.random().toString(36).slice(2));
      s.defer=true;
      document.body.appendChild(s);
    }

    // effects meta
    const EFFECTS = {
      lantern:  { file: '/js/effects/lantern.min.js',  keywords: ['lantern'] },
      sakura:   { file: '/js/effects/sakura.min.js',   keywords: ['sakura','cherry','petal'] },
      snow:     { file: '/js/effects/snowflake.min.js',keywords: ['snow','snowflake'] },
      universe: { file: '/js/effects/universe.min.js', keywords: ['universe','star','galaxy'] },
      circle:   { file: '/js/effects/circleMagic.min.js', keywords: ['circle','circlemagic'] },
      quantum:  { file: '/js/effects/quantum.min.js',  keywords: ['quantum'] },
    };
    const MODES = {
      lantern:  normMode(CFG.effects_lantern_mode),
      sakura:   normMode(CFG.effects_sakura_mode),
      snow:     normMode(CFG.effects_snowflake_mode),
      universe: normMode(CFG.effects_universe_mode),
      circle:   normMode(CFG.effects_circle_magic_mode),
      quantum:  normMode(CFG.effects_quantum_silk_thread_mode),
    };

    // ---- 动态标记新增节点（方便显隐/清理） ----
    const TRACK={};
    function startTrack(key,ms){ TRACK[key]={until:Date.now()+(ms||8000)}; }
    function tagIfMatch(el, key){
      if(!el || el.dataset.diyEffect) return;
      const id=(el.id||'').toLowerCase(), cls=(el.className||'').toString().toLowerCase();
      const kw=EFFECTS[key].keywords;
      const isCanvas = el.tagName==='CANVAS';
      const rect = isCanvas ? el.getBoundingClientRect() : {width:0,height:0};
      const full = isCanvas && rect.width>=window.innerWidth*0.6 && rect.height>=window.innerHeight*0.4;
      if (kw.some(k=>id.includes(k)||cls.includes(k)) || full){
        el.dataset.diyEffect = key;
        try{ el.style.pointerEvents='none'; }catch(e){}
      }
    }
    const bodyObserver=new MutationObserver((muts)=>{
      const now=Date.now();
      muts.forEach(m=>{
        m.addedNodes && m.addedNodes.forEach(node=>{
          if(!(node instanceof HTMLElement) && !(node instanceof HTMLCanvasElement)) return;
          Object.keys(TRACK).forEach(key=>{
            const tk=TRACK[key]; if(!tk || tk.until<now) return;
            tagIfMatch(node,key);
            if(node.querySelectorAll) node.querySelectorAll('*').forEach(ch=>tagIfMatch(ch,key));
          });
        });
      });
    });
    function observeBody(){ if(document.body) bodyObserver.observe(document.body,{childList:true,subtree:true}); else document.addEventListener('DOMContentLoaded',observeBody); }
    observeBody();

    // ---- 获取 / 清理 ----
    function getNodes(key){
      const kw = EFFECTS[key].keywords.join('|');
      const sel = '[data-diy-effect="'+key+'"], body > [id*="'+kw+'"], body > [class*="'+kw+'"]';
      return Array.from(document.querySelectorAll(sel));
    }
    function purgeEffect(key){
      // 1) 标签/关键字节点
      getNodes(key).forEach(el=>{ try{ el.remove(); }catch(e){} });

      // 2) 兜底：超大 Canvas（常见于这些特效），防止漏网
      document.querySelectorAll('body canvas').forEach(cv=>{
        const r = cv.getBoundingClientRect();
        const huge = r.width>=window.innerWidth*0.6 && r.height>=window.innerHeight*0.4;
        if (huge && !cv.closest('[data-keep-canvas]')) {
          try{ cv.remove(); }catch(e){}
        }
      });

      // 3) 清理可能的 script 标签（强制后续可重建）
      document.querySelectorAll('script[data-diy-effect-script="'+key+'"]').forEach(s=>{ try{s.remove();}catch(e){} });
    }
    function createEffect(key){
      startTrack(key, 8000);
      const s = document.createElement('script');
      s.src = ASSETS + EFFECTS[key].file + THEME_VER + '&r=' + Math.random().toString(36).slice(2);
      s.defer = true;
      s.setAttribute('data-diy-effect-script', key);
      document.body.appendChild(s);
    }

    // ---- 构建（每次切换都“强制清理 + 需要则重建”） ----
    let rebuildLock = false;
    function applyVisibilityAndRebuild(){
      if (rebuildLock) return;
      rebuildLock = true;
      try {
        syncScheme();
        const scheme = getCurrentScheme();
        const shouldShow = (mode) => mode==='all' || (mode==='light'&&scheme==='light') || (mode==='dark'&&scheme==='dark');

        Object.keys(EFFECTS).forEach(key=>{
          const mode = MODES[key];
          if (mode==='none') {
            purgeEffect(key);
            return;
          }
          if (shouldShow(mode)) {
            purgeEffect(key);
            createEffect(key);
          } else {
            purgeEffect(key);
          }
        });
      } finally {
        setTimeout(()=>{ rebuildLock=false; }, 100);
      }
    }

    // ---------- 主入口（仅六个显示模式） ----------
    if (!window.__DIY_DISPLAY_MODES_V12__) {
      window.__DIY_DISPLAY_MODES_V12__ = true;
      whenReady(function(){
        // DreamConfig 供脚本内部读取（day/night/all/none）
        window.DreamConfig = window.DreamConfig || {};
        DreamConfig.effects_lantern_mode       = toDayNight(MODES.lantern);
        DreamConfig.effects_sakura_mode        = toDayNight(MODES.sakura);
        DreamConfig.effects_snowflake_mode     = toDayNight(MODES.snow);
        DreamConfig.effects_universe_mode      = toDayNight(MODES.universe);
        DreamConfig.effects_circle_magic_mode  = toDayNight(MODES.circle);
        DreamConfig.effects_quantum_silk_thread_mode = toDayNight(MODES.quantum);

        // 初次构建
        applyVisibilityAndRebuild();

        // 监听主题切换（保持 v12 的“清理 + 重建”策略）
        let rafToken = 0;
        const fire = ()=>{ cancelAnimationFrame(rafToken); rafToken = requestAnimationFrame(applyVisibilityAndRebuild); };
        const mo = new MutationObserver(fire);
        mo.observe(document.documentElement, {attributes:true, attributeFilter:['class','data-theme','theme']});
        window.addEventListener('storage', fire);
      });
    }
  })();
</script>


</body>

</html>
